"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("cross-fetch"),r=require("debug"),s=require("xml-js"),n=require("base-64");exports.DAVNamespace=void 0,(e=exports.DAVNamespace||(exports.DAVNamespace={})).CALENDAR_SERVER="http://calendarserver.org/ns/",e.CALDAV_APPLE="http://apple.com/ns/ical/",e.CALDAV="urn:ietf:params:xml:ns:caldav",e.CARDDAV="urn:ietf:params:xml:ns:carddav",e.DAV="DAV:";const a={[exports.DAVNamespace.CALDAV]:"xmlns:c",[exports.DAVNamespace.CARDDAV]:"xmlns:card",[exports.DAVNamespace.CALENDAR_SERVER]:"xmlns:cs",[exports.DAVNamespace.CALDAV_APPLE]:"xmlns:ca",[exports.DAVNamespace.DAV]:"xmlns:d"};var i,o;exports.DAVNamespaceShort=void 0,(i=exports.DAVNamespaceShort||(exports.DAVNamespaceShort={})).CALDAV="c",i.CARDDAV="card",i.CALENDAR_SERVER="cs",i.CALDAV_APPLE="ca",i.DAV="d",function(e){e.VEVENT="VEVENT",e.VTODO="VTODO",e.VJOURNAL="VJOURNAL",e.VFREEBUSY="VFREEBUSY",e.VTIMEZONE="VTIMEZONE",e.VALARM="VALARM"}(o||(o={}));const l=e=>{const t=Number(e);if(!Number.isNaN(t))return t;const r=e.toLowerCase();return"true"===r||"false"!==r&&e},c=(e,t)=>{if(!e&&!t)return!0;if(!e||!t)return!1;const r=e.trim(),s=t.trim();if(Math.abs(r.length-s.length)>1)return!1;const n="/"===r.slice(-1)?r.slice(0,-1):r,a="/"===s.slice(-1)?s.slice(0,-1):s;return e.includes(a)||t.includes(n)},h=(e,t)=>{if(!e&&!t)return!0;if(!e||!t)return!1;const r=e.trim(),s=t.trim(),n="/"===r.slice(-1)?r.slice(0,-1):r,a="/"===s.slice(-1)?s.slice(0,-1):s;return e.includes(a)||t.includes(n)},u=e=>e.reduce(((e,t)=>({...e,[a[t]]:t})),{}),d=e=>Object.entries(e).reduce(((e,[t,r])=>r?{...e,[t]:r}:e),{}),p=(e,t)=>t?{[e]:t}:{},f=(e,t)=>e?t&&0!==t.length?Object.fromEntries(Object.entries(e).filter((([e])=>!t.includes(e)))):e:{},m=e=>Boolean(null==e?void 0:e.includes(".ics")),y=(e,t)=>{const r=/^\d{4}(-\d\d(-\d\d(T\d\d:\d\d(:\d\d)?(\.\d+)?(([+-]\d\d:\d\d)|Z)?)?)?)?$/i,s=/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(\.\d+)?(([+-]\d\d:\d\d)|Z)?$/i;if(!(r.test(e)&&r.test(t)||s.test(e)&&s.test(t)))throw new Error("invalid timeRange format, not in ISO8601")};var g=Object.freeze({__proto__:null,cleanupFalsy:d,conditionalParam:p,defaultIcsFilter:m,excludeHeaders:f,getDAVAttribute:u,urlContains:h,urlEquals:c,validateISO8601TimeRange:y});const D=r("tsdav:request"),A=async e=>{var r;const{url:n,init:a,convertIncoming:i=!0,parseOutgoing:o=!0,fetchOptions:c={}}=e,{headers:h={},body:u,namespace:p,method:f,attributes:m}=a,y=i?s.js2xml({_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},...u,_attributes:m},{compact:!0,spaces:2,elementNameFn:e=>p&&!/^.+:.+/.test(e)?`${p}:${e}`:e}):u,g={...c};delete g.headers;const A=await t.fetch(n,{headers:{"Content-Type":"text/xml;charset=UTF-8",...d(h),...c.headers||{}},body:y,method:f,...g}),_=await A.text();if(!A.ok||!(null===(r=A.headers.get("content-type"))||void 0===r?void 0:r.includes("xml"))||!o)return[{href:A.url,ok:A.ok,status:A.status,statusText:A.statusText,raw:_}];const O=s.xml2js(_,{compact:!0,trim:!0,textFn:(e,t)=>{try{const r=t._parent,s=Object.keys(r),n=s[s.length-1],a=r[n];if(a.length>0){a[a.length-1]=l(e)}else r[n]=l(e)}catch(e){D(e.stack)}},elementNameFn:e=>e.replace(/^.+:/,"").replace(/([-_]\w)/g,(e=>e[1].toUpperCase())),attributesFn:e=>{const t={...e};return delete t.xmlns,t},ignoreDeclaration:!0});return(Array.isArray(O.multistatus.response)?O.multistatus.response:[O.multistatus.response]).map((e=>{var t,r;if(!e)return{status:A.status,statusText:A.statusText,ok:A.ok};const s=/^\S+\s(?<status>\d+)\s(?<statusText>.+)$/.exec(e.status);return{raw:O,href:e.href,status:(null==s?void 0:s.groups)?Number.parseInt(null==s?void 0:s.groups.status,10):A.status,statusText:null!==(r=null===(t=null==s?void 0:s.groups)||void 0===t?void 0:t.statusText)&&void 0!==r?r:A.statusText,ok:!e.error,error:e.error,responsedescription:e.responsedescription,props:(Array.isArray(e.propstat)?e.propstat:[e.propstat]).reduce(((e,t)=>({...e,...null==t?void 0:t.prop})),{})}}))},_=async e=>{const{url:t,props:r,depth:s,headers:n,headersToExclude:a,fetchOptions:i={}}=e;return A({url:t,init:{method:"PROPFIND",headers:f(d({depth:s,...n}),a),namespace:exports.DAVNamespaceShort.DAV,body:{propfind:{_attributes:u([exports.DAVNamespace.CALDAV,exports.DAVNamespace.CALDAV_APPLE,exports.DAVNamespace.CALENDAR_SERVER,exports.DAVNamespace.CARDDAV,exports.DAVNamespace.DAV]),prop:r}}},fetchOptions:i})},O=async e=>{const{url:r,data:s,headers:n,headersToExclude:a,fetchOptions:i={}}=e;return t.fetch(r,{method:"PUT",body:s,headers:f(n,a),...i})},v=async e=>{const{url:r,data:s,etag:n,headers:a,headersToExclude:i,fetchOptions:o={}}=e;return t.fetch(r,{method:"PUT",body:s,headers:f(d({"If-Match":n,...a}),i),...o})},T=async e=>{const{url:r,headers:s,etag:n,headersToExclude:a,fetchOptions:i={}}=e;return t.fetch(r,{method:"DELETE",headers:f(d({"If-Match":n,...s}),a),...i})};var x=Object.freeze({__proto__:null,createObject:O,davRequest:A,deleteObject:T,propfind:_,updateObject:v});function w(e,t){const r=e=>t.every((t=>e[t]));return Array.isArray(e)?e.every((e=>r(e))):r(e)}const b=(e,t)=>t.reduce(((t,r)=>e[r]?t:`${t.length?`${t},`:""}${r.toString()}`),""),S=r("tsdav:collection"),C=async e=>{const{url:t,body:r,depth:s,defaultNamespace:n=exports.DAVNamespaceShort.DAV,headers:a,headersToExclude:i,fetchOptions:o={}}=e,l=await A({url:t,init:{method:"REPORT",headers:f(d({depth:s,...a}),i),namespace:n,body:r},fetchOptions:o});return 1!==l.length||l[0].raw?l:[]},E=async e=>{const{url:t,props:r,depth:s,headers:n,headersToExclude:a,fetchOptions:i={}}=e;return A({url:t,init:{method:"MKCOL",headers:f(d({depth:s,...n}),a),namespace:exports.DAVNamespaceShort.DAV,body:r?{mkcol:{set:{prop:r}}}:void 0},fetchOptions:i})},V=async e=>{var t,r,s,n,a;const{collection:i,headers:o,headersToExclude:l,fetchOptions:c={}}=e;return null!==(a=null===(n=null===(s=null===(r=null===(t=(await _({url:i.url,props:{[`${exports.DAVNamespaceShort.DAV}:supported-report-set`]:{}},depth:"0",headers:f(o,l),fetchOptions:c}))[0])||void 0===t?void 0:t.props)||void 0===r?void 0:r.supportedReportSet)||void 0===s?void 0:s.supportedReport)||void 0===n?void 0:n.map((e=>Object.keys(e.report)[0])))&&void 0!==a?a:[]},N=async e=>{var t,r,s;const{collection:n,headers:a,headersToExclude:i,fetchOptions:o={}}=e,l=(await _({url:n.url,props:{[`${exports.DAVNamespaceShort.CALENDAR_SERVER}:getctag`]:{}},depth:"0",headers:f(a,i),fetchOptions:o})).filter((e=>h(n.url,e.href)))[0];if(!l)throw new Error("Collection does not exist on server");return{isDirty:`${n.ctag}`!=`${null===(t=l.props)||void 0===t?void 0:t.getctag}`,newCtag:null===(s=null===(r=l.props)||void 0===r?void 0:r.getctag)||void 0===s?void 0:s.toString()}},Y=e=>{const{url:t,props:r,headers:s,syncLevel:n,syncToken:a,headersToExclude:i,fetchOptions:o}=e;return A({url:t,init:{method:"REPORT",namespace:exports.DAVNamespaceShort.DAV,headers:f({...s},i),body:{"sync-collection":{_attributes:u([exports.DAVNamespace.CALDAV,exports.DAVNamespace.CARDDAV,exports.DAVNamespace.DAV]),"sync-level":n,"sync-token":a,[`${exports.DAVNamespaceShort.DAV}:prop`]:r}}},fetchOptions:o})},I=async e=>{var t,r,s,n,a,i,o,l,c,u,d;const{collection:p,method:m,headers:y,headersToExclude:g,account:D,detailedResult:A,fetchOptions:_={}}=e,O=["accountType","homeUrl"];if(!D||!w(D,O)){if(!D)throw new Error("no account for smartCollectionSync");throw new Error(`account must have ${b(D,O)} before smartCollectionSync`)}const v=null!=m?m:(null===(t=p.reports)||void 0===t?void 0:t.includes("syncCollection"))?"webdav":"basic";if(S(`smart collection sync with type ${D.accountType} and method ${v}`),"webdav"===v){const e=await Y({url:p.url,props:{[`${exports.DAVNamespaceShort.DAV}:getetag`]:{},[`${"caldav"===D.accountType?exports.DAVNamespaceShort.CALDAV:exports.DAVNamespaceShort.CARDDAV}:${"caldav"===D.accountType?"calendar-data":"address-data"}`]:{},[`${exports.DAVNamespaceShort.DAV}:displayname`]:{}},syncLevel:1,syncToken:p.syncToken,headers:f(y,g),fetchOptions:_}),t=e.filter((e=>{var t;const r="caldav"===D.accountType?".ics":".vcf";return(null===(t=e.href)||void 0===t?void 0:t.slice(-4))===r})),c=t.filter((e=>404!==e.status)).map((e=>e.href)),u=t.filter((e=>404===e.status)).map((e=>e.href)),d=(c.length&&null!==(s=await(null===(r=null==p?void 0:p.objectMultiGet)||void 0===r?void 0:r.call(p,{url:p.url,props:{[`${exports.DAVNamespaceShort.DAV}:getetag`]:{},[`${"caldav"===D.accountType?exports.DAVNamespaceShort.CALDAV:exports.DAVNamespaceShort.CARDDAV}:${"caldav"===D.accountType?"calendar-data":"address-data"}`]:{}},objectUrls:c,depth:"1",headers:f(y,g),fetchOptions:_})))&&void 0!==s?s:[]).map((e=>{var t,r,s,n,a,i,o,l,c,h;return{url:null!==(t=e.href)&&void 0!==t?t:"",etag:null===(r=e.props)||void 0===r?void 0:r.getetag,data:"caldav"===(null==D?void 0:D.accountType)?null!==(a=null===(n=null===(s=e.props)||void 0===s?void 0:s.calendarData)||void 0===n?void 0:n._cdata)&&void 0!==a?a:null===(i=e.props)||void 0===i?void 0:i.calendarData:null!==(c=null===(l=null===(o=e.props)||void 0===o?void 0:o.addressData)||void 0===l?void 0:l._cdata)&&void 0!==c?c:null===(h=e.props)||void 0===h?void 0:h.addressData}})),m=null!==(n=p.objects)&&void 0!==n?n:[],O=d.filter((e=>m.every((t=>!h(t.url,e.url))))),v=m.reduce(((e,t)=>{const r=d.find((e=>h(e.url,t.url)));return r&&r.etag&&r.etag!==t.etag?[...e,r]:e}),[]),T=u.map((e=>({url:e,etag:""}))),x=m.filter((e=>d.some((t=>h(e.url,t.url)&&t.etag===e.etag))));return{...p,objects:A?{created:O,updated:v,deleted:T}:[...x,...O,...v],syncToken:null!==(l=null===(o=null===(i=null===(a=e[0])||void 0===a?void 0:a.raw)||void 0===i?void 0:i.multistatus)||void 0===o?void 0:o.syncToken)&&void 0!==l?l:p.syncToken}}if("basic"===v){const{isDirty:e,newCtag:t}=await N({collection:p,headers:f(y,g),fetchOptions:_}),r=null!==(c=p.objects)&&void 0!==c?c:[],s=null!==(d=await(null===(u=p.fetchObjects)||void 0===u?void 0:u.call(p,{collection:p,headers:f(y,g),fetchOptions:_})))&&void 0!==d?d:[],n=s.filter((e=>r.every((t=>!h(t.url,e.url))))),a=r.reduce(((e,t)=>{const r=s.find((e=>h(e.url,t.url)));return r&&r.etag&&r.etag!==t.etag?[...e,r]:e}),[]),i=r.filter((e=>s.every((t=>!h(t.url,e.url))))),o=r.filter((e=>s.some((t=>h(e.url,t.url)&&t.etag===e.etag))));if(e)return{...p,objects:A?{created:n,updated:a,deleted:i}:[...o,...n,...a],ctag:t}}return A?{...p,objects:{created:[],updated:[],deleted:[]}}:p};var L=Object.freeze({__proto__:null,collectionQuery:C,isCollectionDirty:N,makeCollection:E,smartCollectionSync:I,supportedReportSet:V,syncCollection:Y});const U=r("tsdav:addressBook"),k=async e=>{const{url:t,props:r,filters:s,depth:n,headers:a,headersToExclude:i,fetchOptions:o={}}=e;return C({url:t,body:{"addressbook-query":d({_attributes:u([exports.DAVNamespace.CARDDAV,exports.DAVNamespace.DAV]),[`${exports.DAVNamespaceShort.DAV}:prop`]:r,filter:null!=s?s:{"prop-filter":{_attributes:{name:"FN"}}}})},defaultNamespace:exports.DAVNamespaceShort.CARDDAV,depth:n,headers:f(a,i),fetchOptions:o})},P=async e=>{const{url:t,props:r,objectUrls:s,depth:n,headers:a,headersToExclude:i,fetchOptions:o={}}=e;return C({url:t,body:{"addressbook-multiget":d({_attributes:u([exports.DAVNamespace.DAV,exports.DAVNamespace.CARDDAV]),[`${exports.DAVNamespaceShort.DAV}:prop`]:r,[`${exports.DAVNamespaceShort.DAV}:href`]:s})},defaultNamespace:exports.DAVNamespaceShort.CARDDAV,depth:n,headers:f(a,i),fetchOptions:o})},B=async e=>{const{account:t,headers:r,props:s,headersToExclude:n,fetchOptions:a={}}=null!=e?e:{},i=["homeUrl","rootUrl"];if(!t||!w(t,i)){if(!t)throw new Error("no account for fetchAddressBooks");throw new Error(`account must have ${b(t,i)} before fetchAddressBooks`)}const o=await _({url:t.homeUrl,props:null!=s?s:{[`${exports.DAVNamespaceShort.DAV}:displayname`]:{},[`${exports.DAVNamespaceShort.CALENDAR_SERVER}:getctag`]:{},[`${exports.DAVNamespaceShort.DAV}:resourcetype`]:{},[`${exports.DAVNamespaceShort.DAV}:sync-token`]:{}},depth:"1",headers:f(r,n),fetchOptions:a});return Promise.all(o.filter((e=>{var t,r;return Object.keys(null!==(r=null===(t=e.props)||void 0===t?void 0:t.resourcetype)&&void 0!==r?r:{}).includes("addressbook")})).map((e=>{var r,s,n,a,i,o,l,c,h;const u=null!==(n=null===(s=null===(r=e.props)||void 0===r?void 0:r.displayname)||void 0===s?void 0:s._cdata)&&void 0!==n?n:null===(a=e.props)||void 0===a?void 0:a.displayname;return U(`Found address book named ${"string"==typeof u?u:""},\n             props: ${JSON.stringify(e.props)}`),{url:new URL(null!==(i=e.href)&&void 0!==i?i:"",null!==(o=t.rootUrl)&&void 0!==o?o:"").href,ctag:null===(l=e.props)||void 0===l?void 0:l.getctag,displayName:"string"==typeof u?u:"",resourcetype:Object.keys(null===(c=e.props)||void 0===c?void 0:c.resourcetype),syncToken:null===(h=e.props)||void 0===h?void 0:h.syncToken}})).map((async e=>({...e,reports:await V({collection:e,headers:f(r,n),fetchOptions:a})}))))},M=async e=>{const{addressBook:t,headers:r,objectUrls:s,headersToExclude:n,urlFilter:a=e=>e,useMultiGet:i=!0,fetchOptions:o={}}=e;U(`Fetching vcards from ${null==t?void 0:t.url}`);const l=["url"];if(!t||!w(t,l)){if(!t)throw new Error("cannot fetchVCards for undefined addressBook");throw new Error(`addressBook must have ${b(t,l)} before fetchVCards`)}const c=(null!=s?s:(await k({url:t.url,props:{[`${exports.DAVNamespaceShort.DAV}:getetag`]:{}},depth:"1",headers:f(r,n),fetchOptions:o})).map((e=>{var t;return e.ok&&null!==(t=e.href)&&void 0!==t?t:""}))).map((e=>e.startsWith("http")||!e?e:new URL(e,t.url).href)).filter(a).map((e=>new URL(e).pathname));let h=[];return c.length>0&&(h=i?await P({url:t.url,props:{[`${exports.DAVNamespaceShort.DAV}:getetag`]:{},[`${exports.DAVNamespaceShort.CARDDAV}:address-data`]:{}},objectUrls:c,depth:"1",headers:f(r,n),fetchOptions:o}):await k({url:t.url,props:{[`${exports.DAVNamespaceShort.DAV}:getetag`]:{},[`${exports.DAVNamespaceShort.CARDDAV}:address-data`]:{}},depth:"1",headers:f(r,n),fetchOptions:o})),h.map((e=>{var r,s,n,a,i,o;return{url:new URL(null!==(r=e.href)&&void 0!==r?r:"",t.url).href,etag:null===(s=e.props)||void 0===s?void 0:s.getetag,data:null!==(i=null===(a=null===(n=e.props)||void 0===n?void 0:n.addressData)||void 0===a?void 0:a._cdata)&&void 0!==i?i:null===(o=e.props)||void 0===o?void 0:o.addressData}}))},R=async e=>{const{addressBook:t,vCardString:r,filename:s,headers:n,headersToExclude:a,fetchOptions:i={}}=e;return O({url:new URL(s,t.url).href,data:r,headers:f({"content-type":"text/vcard; charset=utf-8","If-None-Match":"*",...n},a),fetchOptions:i})},j=async e=>{const{vCard:t,headers:r,headersToExclude:s,fetchOptions:n={}}=e;return v({url:t.url,data:t.data,etag:t.etag,headers:f({"content-type":"text/vcard; charset=utf-8",...r},s),fetchOptions:n})},z=async e=>{const{vCard:t,headers:r,headersToExclude:s,fetchOptions:n={}}=e;return T({url:t.url,etag:t.etag,headers:f(r,s),fetchOptions:n})};var H=Object.freeze({__proto__:null,addressBookMultiGet:P,addressBookQuery:k,createVCard:R,deleteVCard:z,fetchAddressBooks:B,fetchVCards:M,updateVCard:j});const F=r("tsdav:calendar"),$=async e=>{var t,r,s;const{account:n,headers:a,headersToExclude:i,fetchOptions:o={}}=e,l=["principalUrl","rootUrl"];if(!w(n,l))throw new Error(`account must have ${b(n,l)} before fetchUserAddresses`);F(`Fetch user addresses from ${n.principalUrl}`);const c=(await _({url:n.principalUrl,props:{[`${exports.DAVNamespaceShort.CALDAV}:calendar-user-address-set`]:{}},depth:"0",headers:f(a,i),fetchOptions:o})).find((e=>h(n.principalUrl,e.href)));if(!c||!c.ok)throw new Error("cannot find calendarUserAddresses");const u=(null===(s=null===(r=null===(t=null==c?void 0:c.props)||void 0===t?void 0:t.calendarUserAddressSet)||void 0===r?void 0:r.href)||void 0===s?void 0:s.filter(Boolean))||[];return F(`Fetched calendar user addresses ${u}`),u},W=async e=>{const{url:t,props:r,filters:s,timezone:n,depth:a,headers:i,headersToExclude:o,fetchOptions:l={}}=e;return C({url:t,body:{"calendar-query":d({_attributes:u([exports.DAVNamespace.CALDAV,exports.DAVNamespace.CALENDAR_SERVER,exports.DAVNamespace.CALDAV_APPLE,exports.DAVNamespace.DAV]),[`${exports.DAVNamespaceShort.DAV}:prop`]:r,filter:s,timezone:n})},defaultNamespace:exports.DAVNamespaceShort.CALDAV,depth:a,headers:f(i,o),fetchOptions:l})},q=async e=>{const{url:t,props:r,objectUrls:s,filters:n,timezone:a,depth:i,headers:o,headersToExclude:l,fetchOptions:c={}}=e;return C({url:t,body:{"calendar-multiget":d({_attributes:u([exports.DAVNamespace.DAV,exports.DAVNamespace.CALDAV]),[`${exports.DAVNamespaceShort.DAV}:prop`]:r,[`${exports.DAVNamespaceShort.DAV}:href`]:s,filter:n,timezone:a})},defaultNamespace:exports.DAVNamespaceShort.CALDAV,depth:i,headers:f(o,l),fetchOptions:c})},Z=async e=>{const{url:t,props:r,depth:s,headers:n,headersToExclude:a,fetchOptions:i={}}=e;return A({url:t,init:{method:"MKCALENDAR",headers:f(d({depth:s,...n}),a),namespace:exports.DAVNamespaceShort.DAV,body:{[`${exports.DAVNamespaceShort.CALDAV}:mkcalendar`]:{_attributes:u([exports.DAVNamespace.DAV,exports.DAVNamespace.CALDAV,exports.DAVNamespace.CALDAV_APPLE]),set:{prop:r}}}},fetchOptions:i})},K=async e=>{const{headers:t,account:r,props:s,projectedProps:n,headersToExclude:a,fetchOptions:i={}}=null!=e?e:{},l=["homeUrl","rootUrl"];if(!r||!w(r,l)){if(!r)throw new Error("no account for fetchCalendars");throw new Error(`account must have ${b(r,l)} before fetchCalendars`)}const c=await _({url:r.homeUrl,props:null!=s?s:{[`${exports.DAVNamespaceShort.CALDAV}:calendar-description`]:{},[`${exports.DAVNamespaceShort.CALDAV}:calendar-timezone`]:{},[`${exports.DAVNamespaceShort.DAV}:displayname`]:{},[`${exports.DAVNamespaceShort.CALDAV_APPLE}:calendar-color`]:{},[`${exports.DAVNamespaceShort.CALENDAR_SERVER}:getctag`]:{},[`${exports.DAVNamespaceShort.DAV}:resourcetype`]:{},[`${exports.DAVNamespaceShort.CALDAV}:supported-calendar-component-set`]:{},[`${exports.DAVNamespaceShort.DAV}:sync-token`]:{}},depth:"1",headers:f(t,a),fetchOptions:i});return Promise.all(c.filter((e=>{var t,r;return Object.keys(null!==(r=null===(t=e.props)||void 0===t?void 0:t.resourcetype)&&void 0!==r?r:{}).includes("calendar")})).filter((e=>{var t,r,s,n,a,i;return(Array.isArray(null===(r=null===(t=e.props)||void 0===t?void 0:t.supportedCalendarComponentSet)||void 0===r?void 0:r.comp)?null===(s=e.props)||void 0===s?void 0:s.supportedCalendarComponentSet.comp.map((e=>e._attributes.name)):[null===(i=null===(a=null===(n=e.props)||void 0===n?void 0:n.supportedCalendarComponentSet)||void 0===a?void 0:a.comp)||void 0===i?void 0:i._attributes.name]).some((e=>Object.values(o).includes(e)))})).map((e=>{var t,s,a,i,o,l,c,h,u,d,f,m,y,g,D,A;const _=null===(t=e.props)||void 0===t?void 0:t.calendarDescription,O=null===(s=e.props)||void 0===s?void 0:s.calendarTimezone;return{description:"string"==typeof _?_:"",timezone:"string"==typeof O?O:"",url:new URL(null!==(a=e.href)&&void 0!==a?a:"",null!==(i=r.rootUrl)&&void 0!==i?i:"").href,ctag:null===(o=e.props)||void 0===o?void 0:o.getctag,calendarColor:null===(l=e.props)||void 0===l?void 0:l.calendarColor,displayName:null!==(h=null===(c=e.props)||void 0===c?void 0:c.displayname._cdata)&&void 0!==h?h:null===(u=e.props)||void 0===u?void 0:u.displayname,components:Array.isArray(null===(d=e.props)||void 0===d?void 0:d.supportedCalendarComponentSet.comp)?null===(f=e.props)||void 0===f?void 0:f.supportedCalendarComponentSet.comp.map((e=>e._attributes.name)):[null===(y=null===(m=e.props)||void 0===m?void 0:m.supportedCalendarComponentSet.comp)||void 0===y?void 0:y._attributes.name],resourcetype:Object.keys(null===(g=e.props)||void 0===g?void 0:g.resourcetype),syncToken:null===(D=e.props)||void 0===D?void 0:D.syncToken,...p("projectedProps",Object.fromEntries(Object.entries(null!==(A=e.props)&&void 0!==A?A:{}).filter((([e])=>null==n?void 0:n[e]))))}})).map((async e=>({...e,reports:await V({collection:e,headers:f(t,a),fetchOptions:i})}))))},J=async e=>{const{calendar:t,objectUrls:r,filters:s,timeRange:n,headers:a,expand:i,urlFilter:o=e=>Boolean(null==e?void 0:e.includes(".ics")),useMultiGet:l=!0,headersToExclude:c,fetchOptions:h={}}=e;if(n){const e=/^\d{4}(-\d\d(-\d\d(T\d\d:\d\d(:\d\d)?(\.\d+)?(([+-]\d\d:\d\d)|Z)?)?)?)?$/i,t=/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(\.\d+)?(([+-]\d\d:\d\d)|Z)?$/i;if(!(e.test(n.start)&&e.test(n.end)||t.test(n.start)&&t.test(n.end)))throw new Error("invalid timeRange format, not in ISO8601")}F(`Fetching calendar objects from ${null==t?void 0:t.url}`);const u=["url"];if(!t||!w(t,u)){if(!t)throw new Error("cannot fetchCalendarObjects for undefined calendar");throw new Error(`calendar must have ${b(t,u)} before fetchCalendarObjects`)}const d=null!=s?s:[{"comp-filter":{_attributes:{name:"VCALENDAR"},"comp-filter":{_attributes:{name:"VEVENT"},...n?{"time-range":{_attributes:{start:`${new Date(n.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(n.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}}:{}}}}],p=(null!=r?r:(await W({url:t.url,props:{[`${exports.DAVNamespaceShort.DAV}:getetag`]:{...i&&n?{[`${exports.DAVNamespaceShort.CALDAV}:expand`]:{_attributes:{start:`${new Date(n.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(n.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}}:{}}},filters:d,depth:"1",headers:f(a,c),fetchOptions:h})).map((e=>{var t;return null!==(t=e.href)&&void 0!==t?t:""}))).map((e=>e.startsWith("http")||!e?e:new URL(e,t.url).href)).filter(o).map((e=>new URL(e).pathname));let m=[];return p.length>0&&(m=!l||i?await W({url:t.url,props:{[`${exports.DAVNamespaceShort.DAV}:getetag`]:{},[`${exports.DAVNamespaceShort.CALDAV}:calendar-data`]:{...i&&n?{[`${exports.DAVNamespaceShort.CALDAV}:expand`]:{_attributes:{start:`${new Date(n.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(n.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}}:{}}},filters:d,depth:"1",headers:f(a,c),fetchOptions:h}):await q({url:t.url,props:{[`${exports.DAVNamespaceShort.DAV}:getetag`]:{},[`${exports.DAVNamespaceShort.CALDAV}:calendar-data`]:{...i&&n?{[`${exports.DAVNamespaceShort.CALDAV}:expand`]:{_attributes:{start:`${new Date(n.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(n.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}}:{}}},objectUrls:p,depth:"1",headers:f(a,c),fetchOptions:h})),m.map((e=>{var r,s,n,a,i,o;return{url:new URL(null!==(r=e.href)&&void 0!==r?r:"",t.url).href,etag:`${null===(s=e.props)||void 0===s?void 0:s.getetag}`,data:null!==(i=null===(a=null===(n=e.props)||void 0===n?void 0:n.calendarData)||void 0===a?void 0:a._cdata)&&void 0!==i?i:null===(o=e.props)||void 0===o?void 0:o.calendarData}}))},G=async e=>{const{calendar:t,iCalString:r,filename:s,headers:n,headersToExclude:a,fetchOptions:i={}}=e;return O({url:new URL(s,t.url).href,data:r,headers:f({"content-type":"text/calendar; charset=utf-8","If-None-Match":"*",...n},a),fetchOptions:i})},Q=async e=>{const{calendarObject:t,headers:r,headersToExclude:s,fetchOptions:n={}}=e;return v({url:t.url,data:t.data,etag:t.etag,headers:f({"content-type":"text/calendar; charset=utf-8",...r},s),fetchOptions:n})},X=async e=>{const{calendarObject:t,headers:r,headersToExclude:s,fetchOptions:n={}}=e;return T({url:t.url,etag:t.etag,headers:f(r,s),fetchOptions:n})},ee=async e=>{var t;const{oldCalendars:r,account:s,detailedResult:n,headers:a,headersToExclude:i,fetchOptions:o={}}=e;if(!s)throw new Error("Must have account before syncCalendars");const l=null!==(t=null!=r?r:s.calendars)&&void 0!==t?t:[],c=await K({account:s,headers:f(a,i),fetchOptions:o}),u=c.filter((e=>l.every((t=>!h(t.url,e.url)))));F(`new calendars: ${u.map((e=>e.displayName))}`);const d=l.reduce(((e,t)=>{const r=c.find((e=>h(e.url,t.url)));return r&&(r.syncToken&&`${r.syncToken}`!=`${t.syncToken}`||r.ctag&&`${r.ctag}`!=`${t.ctag}`)?[...e,r]:e}),[]);F(`updated calendars: ${d.map((e=>e.displayName))}`);const p=await Promise.all(d.map((async e=>await I({collection:{...e,objectMultiGet:q},method:"webdav",headers:f(a,i),account:s,fetchOptions:o})))),m=l.filter((e=>c.every((t=>!h(t.url,e.url)))));F(`deleted calendars: ${m.map((e=>e.displayName))}`);const y=l.filter((e=>c.some((t=>h(t.url,e.url)&&(t.syncToken&&`${t.syncToken}`!=`${e.syncToken}`||t.ctag&&`${t.ctag}`!=`${e.ctag}`)))));return n?{created:u,updated:d,deleted:m}:[...y,...u,...p]},te=async e=>{const{url:t,timeRange:r,depth:s,headers:n,headersToExclude:a,fetchOptions:i={}}=e;if(!r)throw new Error("timeRange is required");{const e=/^\d{4}(-\d\d(-\d\d(T\d\d:\d\d(:\d\d)?(\.\d+)?(([+-]\d\d:\d\d)|Z)?)?)?)?$/i,t=/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(\.\d+)?(([+-]\d\d:\d\d)|Z)?$/i;if(!(e.test(r.start)&&e.test(r.end)||t.test(r.start)&&t.test(r.end)))throw new Error("invalid timeRange format, not in ISO8601")}return(await C({url:t,body:{"free-busy-query":d({_attributes:u([exports.DAVNamespace.CALDAV]),[`${exports.DAVNamespaceShort.CALDAV}:time-range`]:{_attributes:{start:`${new Date(r.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(r.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}})},defaultNamespace:exports.DAVNamespaceShort.CALDAV,depth:s,headers:f(n,a),fetchOptions:i}))[0]};var re=Object.freeze({__proto__:null,calendarMultiGet:q,calendarQuery:W,createCalendarObject:G,deleteCalendarObject:X,fetchCalendarObjects:J,fetchCalendarUserAddresses:$,fetchCalendars:K,freeBusyQuery:te,makeCalendar:Z,syncCalendars:ee,updateCalendarObject:Q});const se=r("tsdav:account"),ne=async e=>{var r,s;se("Service discovery...");const{account:n,headers:a,headersToExclude:i,fetchOptions:o={}}=e,l=new URL(n.serverUrl),c=new URL(`/.well-known/${n.accountType}`,l);c.protocol=null!==(r=l.protocol)&&void 0!==r?r:"http";try{const e=await t.fetch(c.href,{headers:f(a,i),method:"PROPFIND",redirect:"manual",...o});if(e.status>=300&&e.status<400){const t=e.headers.get("Location");if("string"==typeof t&&t.length){se(`Service discovery redirected to ${t}`);const e=new URL(t,l);return e.hostname===c.hostname&&c.port&&!e.port&&(e.port=c.port),e.protocol=null!==(s=l.protocol)&&void 0!==s?s:"http",e.href}}}catch(e){se(`Service discovery failed: ${e.stack}`)}return l.href},ae=async e=>{var t,r,s,n,a;const{account:i,headers:o,headersToExclude:l,fetchOptions:c={}}=e,h=["rootUrl"];if(!w(i,h))throw new Error(`account must have ${b(i,h)} before fetchPrincipalUrl`);se(`Fetching principal url from path ${i.rootUrl}`);const[u]=await _({url:i.rootUrl,props:{[`${exports.DAVNamespaceShort.DAV}:current-user-principal`]:{}},depth:"0",headers:f(o,l),fetchOptions:c});if(!u.ok&&(se(`Fetch principal url failed: ${u.statusText}`),401===u.status))throw new Error("Invalid credentials");return se(`Fetched principal url ${null===(r=null===(t=u.props)||void 0===t?void 0:t.currentUserPrincipal)||void 0===r?void 0:r.href}`),new URL(null!==(a=null===(n=null===(s=u.props)||void 0===s?void 0:s.currentUserPrincipal)||void 0===n?void 0:n.href)&&void 0!==a?a:"",i.rootUrl).href},ie=async e=>{var t,r;const{account:s,headers:n,headersToExclude:a,fetchOptions:i={}}=e,o=["principalUrl","rootUrl"];if(!w(s,o))throw new Error(`account must have ${b(s,o)} before fetchHomeUrl`);se(`Fetch home url from ${s.principalUrl}`);const l=await _({url:s.principalUrl,props:"caldav"===s.accountType?{[`${exports.DAVNamespaceShort.CALDAV}:calendar-home-set`]:{}}:{[`${exports.DAVNamespaceShort.CARDDAV}:addressbook-home-set`]:{}},depth:"0",headers:f(n,a),fetchOptions:i}),c=l.find((e=>h(s.principalUrl,e.href)));if(!c||!c.ok)throw se(`Fetch home url failed with status ${null==c?void 0:c.statusText} and error ${JSON.stringify(l.map((e=>e.error)))}`),new Error("cannot find homeUrl");const u=new URL("caldav"===s.accountType?null===(t=null==c?void 0:c.props)||void 0===t?void 0:t.calendarHomeSet.href:null===(r=null==c?void 0:c.props)||void 0===r?void 0:r.addressbookHomeSet.href,s.rootUrl).href;return se(`Fetched home url ${u}`),u},oe=async e=>{const{account:t,headers:r,loadCollections:s=!1,loadObjects:n=!1,headersToExclude:a,fetchOptions:i={}}=e,o={...t};return o.rootUrl=await ne({account:t,headers:f(r,a),fetchOptions:i}),o.principalUrl=await ae({account:o,headers:f(r,a),fetchOptions:i}),o.homeUrl=await ie({account:o,headers:f(r,a),fetchOptions:i}),(s||n)&&("caldav"===t.accountType?o.calendars=await K({headers:f(r,a),account:o,fetchOptions:i}):"carddav"===t.accountType&&(o.addressBooks=await B({headers:f(r,a),account:o,fetchOptions:i}))),n&&("caldav"===t.accountType&&o.calendars?o.calendars=await Promise.all(o.calendars.map((async e=>({...e,objects:await J({calendar:e,headers:f(r,a),fetchOptions:i})})))):"carddav"===t.accountType&&o.addressBooks&&(o.addressBooks=await Promise.all(o.addressBooks.map((async e=>({...e,objects:await M({addressBook:e,headers:f(r,a),fetchOptions:i})})))))),o};var le=Object.freeze({__proto__:null,createAccount:oe,fetchHomeUrl:ie,fetchPrincipalUrl:ae,serviceDiscovery:ne});const ce=r("tsdav:todo"),he=e=>({[`${exports.DAVNamespaceShort.CALDAV}:expand`]:{_attributes:{start:`${new Date(e.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(e.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}}),ue=async e=>{const{url:t,props:r,filters:s,timezone:n,depth:a,headers:i,headersToExclude:o,fetchOptions:l={}}=e;return C({url:t,body:{"calendar-query":d({_attributes:u([exports.DAVNamespace.CALDAV,exports.DAVNamespace.CALENDAR_SERVER,exports.DAVNamespace.CALDAV_APPLE,exports.DAVNamespace.DAV]),[`${exports.DAVNamespaceShort.DAV}:prop`]:r,filter:s,timezone:n})},defaultNamespace:exports.DAVNamespaceShort.CALDAV,depth:a,headers:f(i,o),fetchOptions:l})},de=async e=>{const{url:t,props:r,objectUrls:s,filters:n,timezone:a,depth:i,headers:o,headersToExclude:l,fetchOptions:c={}}=e;return C({url:t,body:{"calendar-multiget":d({_attributes:u([exports.DAVNamespace.DAV,exports.DAVNamespace.CALDAV]),[`${exports.DAVNamespaceShort.DAV}:prop`]:r,[`${exports.DAVNamespaceShort.DAV}:href`]:s,filter:n,timezone:a})},defaultNamespace:exports.DAVNamespaceShort.CALDAV,depth:i,headers:f(o,l),fetchOptions:c})},pe=async e=>{const{calendar:t,objectUrls:r,filters:s,timeRange:n,headers:a,expand:i,urlFilter:o=m,useMultiGet:l=!0,headersToExclude:c,fetchOptions:h={}}=e;n&&y(n.start,n.end),ce(`Fetching todo objects from ${null==t?void 0:t.url}`);const u=["url"];if(!t||!w(t,u)){if(!t)throw new Error("cannot fetchTodos for undefined calendar");throw new Error(`calendar must have ${b(t,u)} before fetchTodos`)}const d=null!=s?s:[{"comp-filter":{_attributes:{name:"VCALENDAR"},"comp-filter":{_attributes:{name:"VTODO"},...n?{"time-range":{_attributes:{start:`${new Date(n.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(n.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}}:{}}}}],p=(null!=r?r:(await ue({url:t.url,props:{[`${exports.DAVNamespaceShort.DAV}:getetag`]:{...i&&n?he(n):{}}},filters:d,depth:"1",headers:f(a,c),fetchOptions:h})).map((e=>{var t;return null!==(t=e.href)&&void 0!==t?t:""}))).map((e=>e.startsWith("http")||!e?e:new URL(e,t.url).href)).filter(o).map((e=>new URL(e).pathname));let g=[];return p.length>0&&(g=!l||i?await ue({url:t.url,props:{[`${exports.DAVNamespaceShort.DAV}:getetag`]:{},[`${exports.DAVNamespaceShort.CALDAV}:calendar-data`]:{...i&&n?he(n):{}}},filters:d,depth:"1",headers:f(a,c),fetchOptions:h}):await de({url:t.url,props:{[`${exports.DAVNamespaceShort.DAV}:getetag`]:{},[`${exports.DAVNamespaceShort.CALDAV}:calendar-data`]:{...i&&n?he(n):{}}},objectUrls:p,depth:"1",headers:f(a,c),fetchOptions:h})),g.map((e=>{var r,s,n,a,i,o;return{url:new URL(null!==(r=e.href)&&void 0!==r?r:"",t.url).href,etag:`${null===(s=e.props)||void 0===s?void 0:s.getetag}`,data:null!==(i=null===(a=null===(n=e.props)||void 0===n?void 0:n.calendarData)||void 0===a?void 0:a._cdata)&&void 0!==i?i:null===(o=e.props)||void 0===o?void 0:o.calendarData}}))},fe=async e=>{const{calendar:t,iCalString:r,filename:s,headers:n,headersToExclude:a,fetchOptions:i={}}=e;if(!r.includes("UID:"))throw new Error("iCalString must contain a UID");return O({url:new URL(s,t.url).href,data:r,headers:f({"content-type":"text/calendar; charset=utf-8","If-None-Match":"*",...n},a),fetchOptions:i})},me=async e=>{const{calendarObject:t,headers:r,headersToExclude:s,fetchOptions:n={}}=e;if(!t.etag)throw new Error("calendarObject must have etag for update - fetch todo first");return v({url:t.url,data:t.data,etag:t.etag,headers:f({"content-type":"text/calendar; charset=utf-8",...r},s),fetchOptions:n})},ye=async e=>{const{calendarObject:t,headers:r,headersToExclude:s,fetchOptions:n={}}=e;return T({url:t.url,etag:t.etag,headers:f(r,s),fetchOptions:n})};var ge=Object.freeze({__proto__:null,createTodo:fe,deleteTodo:ye,fetchTodos:pe,todoMultiGet:de,todoQuery:ue,updateTodo:me});const De=r("tsdav:authHelper"),Ae=(e,t)=>(...r)=>e({...t,...r[0]}),_e=e=>(De(`Basic auth token generated: ${n.encode(`${e.username}:${e.password}`)}`),{authorization:`Basic ${n.encode(`${e.username}:${e.password}`)}`}),Oe=async(e,r)=>{const s=["authorizationCode","redirectUrl","clientId","clientSecret","tokenUrl"];if(!w(e,s))throw new Error(`Oauth credentials missing: ${b(e,s)}`);const n=new URLSearchParams({grant_type:"authorization_code",code:e.authorizationCode,redirect_uri:e.redirectUrl,client_id:e.clientId,client_secret:e.clientSecret});De(e.tokenUrl),De(n.toString());const a=await t.fetch(e.tokenUrl,{method:"POST",body:n.toString(),headers:{"content-length":`${n.toString().length}`,"content-type":"application/x-www-form-urlencoded"},...null!=r?r:{}});if(a.ok){return await a.json()}return De(`Fetch Oauth tokens failed: ${await a.text()}`),{}},ve=async(e,r)=>{const s=["refreshToken","clientId","clientSecret","tokenUrl"];if(!w(e,s))throw new Error(`Oauth credentials missing: ${b(e,s)}`);const n=new URLSearchParams({client_id:e.clientId,client_secret:e.clientSecret,refresh_token:e.refreshToken,grant_type:"refresh_token"}),a=await t.fetch(e.tokenUrl,{method:"POST",body:n.toString(),headers:{"Content-Type":"application/x-www-form-urlencoded"},...null!=r?r:{}});if(a.ok){return await a.json()}return De(`Refresh access token failed: ${await a.text()}`),{}},Te=async(e,t)=>{var r;De("Fetching oauth headers");let s={};return e.refreshToken?(e.refreshToken&&!e.accessToken||Date.now()>(null!==(r=e.expiration)&&void 0!==r?r:0))&&(s=await ve(e,t)):s=await Oe(e,t),De(`Oauth tokens fetched: ${s.access_token}`),{tokens:s,headers:{authorization:`Bearer ${s.access_token}`}}};var xe=Object.freeze({__proto__:null,defaultParam:Ae,fetchOauthTokens:Oe,getBasicAuthHeaders:_e,getOauthHeaders:Te,refreshAccessToken:ve});const we=async e=>{var t;const{serverUrl:r,credentials:s,authMethod:n,defaultAccountType:a,authFunction:i}=e;let o={};switch(n){case"Basic":o=_e(s);break;case"Oauth":o=(await Te(s)).headers;break;case"Digest":o={Authorization:`Digest ${s.digestString}`};break;case"Custom":o=null!==(t=await(null==i?void 0:i(s)))&&void 0!==t?t:{};break;default:throw new Error("Invalid auth method")}const l=a?await oe({account:{serverUrl:r,credentials:s,accountType:a},headers:o}):void 0,c=Ae(O,{url:r,headers:o}),h=Ae(v,{headers:o,url:r}),u=Ae(T,{headers:o,url:r}),d=Ae(_,{headers:o}),p=Ae(C,{headers:o}),f=Ae(E,{headers:o}),m=Ae(Y,{headers:o}),y=Ae(V,{headers:o}),g=Ae(N,{headers:o}),D=Ae(I,{headers:o,account:l}),x=Ae(W,{headers:o}),w=Ae(q,{headers:o}),b=Ae(Z,{headers:o}),S=Ae(K,{headers:o,account:l}),L=Ae($,{headers:o,account:l}),U=Ae(J,{headers:o}),H=Ae(G,{headers:o}),F=Ae(Q,{headers:o}),te=Ae(X,{headers:o}),re=Ae(ee,{account:l,headers:o}),se=Ae(k,{headers:o}),ne=Ae(P,{headers:o});return{davRequest:async e=>{const{init:t,...r}=e,{headers:s,...n}=t;return A({...r,init:{...n,headers:{...o,...s}}})},propfind:d,createAccount:async e=>{const{account:t,headers:n,loadCollections:a,loadObjects:i}=e;return oe({account:{serverUrl:r,credentials:s,...t},headers:{...o,...n},loadCollections:a,loadObjects:i})},createObject:c,updateObject:h,deleteObject:u,calendarQuery:x,addressBookQuery:se,collectionQuery:p,makeCollection:f,calendarMultiGet:w,makeCalendar:b,syncCollection:m,supportedReportSet:y,isCollectionDirty:g,smartCollectionSync:D,fetchCalendars:S,fetchCalendarUserAddresses:L,fetchCalendarObjects:U,createCalendarObject:H,updateCalendarObject:F,deleteCalendarObject:te,syncCalendars:re,fetchAddressBooks:Ae(B,{account:l,headers:o}),addressBookMultiGet:ne,fetchVCards:Ae(M,{headers:o}),createVCard:Ae(R,{headers:o}),updateVCard:Ae(j,{headers:o}),deleteVCard:Ae(z,{headers:o}),todoQuery:Ae(ue,{headers:o}),todoMultiGet:Ae(de,{headers:o}),fetchTodos:Ae(pe,{headers:o}),createTodo:Ae(fe,{headers:o}),updateTodo:Ae(me,{headers:o}),deleteTodo:Ae(ye,{headers:o})}};class be{constructor(e){var t,r,s;this.serverUrl=e.serverUrl,this.credentials=e.credentials,this.authMethod=null!==(t=e.authMethod)&&void 0!==t?t:"Basic",this.accountType=null!==(r=e.defaultAccountType)&&void 0!==r?r:"caldav",this.authFunction=e.authFunction,this.fetchOptions=null!==(s=e.fetchOptions)&&void 0!==s?s:{}}async login(){var e;switch(this.authMethod){case"Basic":this.authHeaders=_e(this.credentials);break;case"Oauth":this.authHeaders=(await Te(this.credentials,this.fetchOptions)).headers;break;case"Digest":this.authHeaders={Authorization:`Digest ${this.credentials.digestString}`};break;case"Custom":this.authHeaders=await(null===(e=this.authFunction)||void 0===e?void 0:e.call(this,this.credentials));break;default:throw new Error("Invalid auth method")}this.account=this.accountType?await oe({account:{serverUrl:this.serverUrl,credentials:this.credentials,accountType:this.accountType},headers:this.authHeaders,fetchOptions:this.fetchOptions}):void 0}async davRequest(e){const{init:t,...r}=e,{headers:s,...n}=t;return A({...r,init:{...n,headers:{...this.authHeaders,...s}},fetchOptions:this.fetchOptions})}async createObject(...e){return Ae(O,{url:this.serverUrl,headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async updateObject(...e){return Ae(v,{url:this.serverUrl,headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async deleteObject(...e){return Ae(T,{url:this.serverUrl,headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async propfind(...e){return Ae(_,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async createAccount(e){const{account:t,headers:r,loadCollections:s,loadObjects:n,fetchOptions:a}=e;return oe({account:{serverUrl:this.serverUrl,credentials:this.credentials,...t},headers:{...this.authHeaders,...r},loadCollections:s,loadObjects:n,fetchOptions:null!=a?a:this.fetchOptions})}async collectionQuery(...e){return Ae(C,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async makeCollection(...e){return Ae(E,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async syncCollection(...e){return Ae(Y,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async supportedReportSet(...e){return Ae(V,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async isCollectionDirty(...e){return Ae(N,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async smartCollectionSync(...e){return Ae(I,{headers:this.authHeaders,fetchOptions:this.fetchOptions,account:this.account})(e[0])}async calendarQuery(...e){return Ae(W,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async makeCalendar(...e){return Ae(Z,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async calendarMultiGet(...e){return Ae(q,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async fetchCalendars(...e){return Ae(K,{headers:this.authHeaders,account:this.account,fetchOptions:this.fetchOptions})(null==e?void 0:e[0])}async fetchCalendarUserAddresses(...e){return Ae($,{headers:this.authHeaders,account:this.account,fetchOptions:this.fetchOptions})(null==e?void 0:e[0])}async fetchCalendarObjects(...e){return Ae(J,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async createCalendarObject(...e){return Ae(G,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async updateCalendarObject(...e){return Ae(Q,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async deleteCalendarObject(...e){return Ae(X,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async syncCalendars(...e){return Ae(ee,{headers:this.authHeaders,account:this.account,fetchOptions:this.fetchOptions})(e[0])}async addressBookQuery(...e){return Ae(k,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async addressBookMultiGet(...e){return Ae(P,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async fetchAddressBooks(...e){return Ae(B,{headers:this.authHeaders,account:this.account,fetchOptions:this.fetchOptions})(null==e?void 0:e[0])}async fetchVCards(...e){return Ae(M,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async createVCard(...e){return Ae(R,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async updateVCard(...e){return Ae(j,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async deleteVCard(...e){return Ae(z,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async todoQuery(...e){return Ae(ue,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async todoMultiGet(...e){return Ae(de,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async fetchTodos(...e){return Ae(pe,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async createTodo(...e){return Ae(fe,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async updateTodo(...e){return Ae(me,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}async deleteTodo(...e){return Ae(ye,{headers:this.authHeaders,fetchOptions:this.fetchOptions})(e[0])}}var Se=Object.freeze({__proto__:null,DAVClient:be,createDAVClient:we});class Ce{static fromString(e){return new Ce(e)}constructor(e){this.value=e}icaltype="binary";decodeValue(){return this._b64_decode(this.value)}setEncodedValue(e){this.value=this._b64_encode(e)}_b64_encode(e){let t,r,s,n,a,i,o,l,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h=0,u=0,d="",p=[];if(!e)return e;do{t=e.charCodeAt(h++),r=e.charCodeAt(h++),s=e.charCodeAt(h++),l=t<<16|r<<8|s,n=l>>18&63,a=l>>12&63,i=l>>6&63,o=63&l,p[u++]=c.charAt(n)+c.charAt(a)+c.charAt(i)+c.charAt(o)}while(h<e.length);d=p.join("");let f=e.length%3;return(f?d.slice(0,f-3):d)+"===".slice(f||3)}_b64_decode(e){let t,r,s,n,a,i,o,l,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h=0,u=0,d="",p=[];if(!e)return e;e+="";do{n=c.indexOf(e.charAt(h++)),a=c.indexOf(e.charAt(h++)),i=c.indexOf(e.charAt(h++)),o=c.indexOf(e.charAt(h++)),l=n<<18|a<<12|i<<6|o,t=l>>16&255,r=l>>8&255,s=255&l,p[u++]=64==i?String.fromCharCode(t):64==o?String.fromCharCode(t,r):String.fromCharCode(t,r,s)}while(h<e.length);return d=p.join(""),d}toString(){return this.value}}const Ee=/([PDWHMTS]{1,1})/,Ve=["weeks","days","hours","minutes","seconds","isNegative"];class Ne{static fromSeconds(e){return(new Ne).fromSeconds(e)}static isValueString(e){return"P"===e[0]||"P"===e[1]}static fromString(e){let t=0,r=Object.create(null),s=0;for(;-1!==(t=e.search(Ee));){let n=e[t],a=e.slice(0,Math.max(0,t));e=e.slice(t+1),s+=Ye(n,a,r)}if(s<2)throw new Error('invalid duration value: Not enough duration components in "'+e+'"');return new Ne(r)}static fromData(e){return new Ne(e)}constructor(e){this.wrappedJSObject=this,this.fromData(e)}weeks=0;days=0;hours=0;minutes=0;seconds=0;isNegative=!1;icalclass="icalduration";icaltype="duration";clone(){return Ne.fromData(this)}toSeconds(){let e=this.seconds+60*this.minutes+3600*this.hours+86400*this.days+604800*this.weeks;return this.isNegative?-e:e}fromSeconds(e){let t=Math.abs(e);return this.isNegative=e<0,this.days=Qe(t/86400),this.days%7==0?(this.weeks=this.days/7,this.days=0):this.weeks=0,t-=86400*(this.days+7*this.weeks),this.hours=Qe(t/3600),t-=3600*this.hours,this.minutes=Qe(t/60),t-=60*this.minutes,this.seconds=t,this}fromData(e){for(let t of Ve)this[t]=e&&t in e?e[t]:0}reset(){this.isNegative=!1,this.weeks=0,this.days=0,this.hours=0,this.minutes=0,this.seconds=0}compare(e){let t=this.toSeconds(),r=e.toSeconds();return(t>r)-(t<r)}normalize(){this.fromSeconds(this.toSeconds())}toString(){if(0==this.toSeconds())return"PT0S";{let e="";this.isNegative&&(e+="-"),e+="P";let t=!1;return this.weeks?this.days||this.hours||this.minutes||this.seconds?e+=7*this.weeks+this.days+"D":(e+=this.weeks+"W",t=!0):this.days&&(e+=this.days+"D"),t||(this.hours||this.minutes||this.seconds)&&(e+="T",this.hours&&(e+=this.hours+"H"),this.minutes&&(e+=this.minutes+"M"),this.seconds&&(e+=this.seconds+"S")),e}}toICALString(){return this.toString()}}function Ye(e,t,r){let s;switch(e){case"P":r.isNegative=!(!t||"-"!==t);break;case"D":s="days";break;case"W":s="weeks";break;case"H":s="hours";break;case"M":s="minutes";break;case"S":s="seconds";break;default:return 0}if(s){if(!t&&0!==t)throw new Error('invalid duration value: Missing number before "'+e+'"');let n=parseInt(t,10);if(Fe(n))throw new Error('invalid duration value: Invalid number "'+t+'" before "'+e+'"');r[s]=n}return 1}class Ie{static fromString(e,t){let r=e.split("/");if(2!==r.length)throw new Error('Invalid string value: "'+e+'" must contain a "/" char.');let s={start:Le.fromDateTimeString(r[0],t)},n=r[1];return Ne.isValueString(n)?s.duration=Ne.fromString(n):s.end=Le.fromDateTimeString(n,t),new Ie(s)}static fromData(e){return new Ie(e)}static fromJSON(e,t,r){function s(e,t){return r?Le.fromString(e,t):Le.fromDateTimeString(e,t)}return Ne.isValueString(e[1])?Ie.fromData({start:s(e[0],t),duration:Ne.fromString(e[1])}):Ie.fromData({start:s(e[0],t),end:s(e[1],t)})}constructor(e){if(this.wrappedJSObject=this,e&&"start"in e){if(e.start&&!(e.start instanceof Le))throw new TypeError(".start must be an instance of ICAL.Time");this.start=e.start}if(e&&e.end&&e.duration)throw new Error("cannot accept both end and duration");if(e&&"end"in e){if(e.end&&!(e.end instanceof Le))throw new TypeError(".end must be an instance of ICAL.Time");this.end=e.end}if(e&&"duration"in e){if(e.duration&&!(e.duration instanceof Ne))throw new TypeError(".duration must be an instance of ICAL.Duration");this.duration=e.duration}}start=null;end=null;duration=null;icalclass="icalperiod";icaltype="period";clone(){return Ie.fromData({start:this.start?this.start.clone():null,end:this.end?this.end.clone():null,duration:this.duration?this.duration.clone():null})}getDuration(){return this.duration?this.duration:this.end.subtractDate(this.start)}getEnd(){if(this.end)return this.end;{let e=this.start.clone();return e.addDuration(this.duration),e}}compare(e){return e.compare(this.start)<0?1:e.compare(this.getEnd())>0?-1:0}toString(){return this.start+"/"+(this.end||this.duration)}toJSON(){return[this.start.toString(),(this.end||this.duration).toString()]}toICALString(){return this.start.toICALString()+"/"+(this.end||this.duration).toICALString()}}class Le{static _dowCache={};static _wnCache={};static daysInMonth(e,t){let r=30;return e<1||e>12||(r=[0,31,28,31,30,31,30,31,31,30,31,30,31][e],2==e&&(r+=Le.isLeapYear(t))),r}static isLeapYear(e){return e<=1752?e%4==0:e%4==0&&e%100!=0||e%400==0}static fromDayOfYear(e,t){let r=t,s=e,n=new Le;n.auto_normalize=!1;let a=Le.isLeapYear(r)?1:0;if(s<1)return r--,a=Le.isLeapYear(r)?1:0,s+=Le.daysInYearPassedMonth[a][12],Le.fromDayOfYear(s,r);if(s>Le.daysInYearPassedMonth[a][12])return a=Le.isLeapYear(r)?1:0,s-=Le.daysInYearPassedMonth[a][12],r++,Le.fromDayOfYear(s,r);n.year=r,n.isDate=!0;for(let e=11;e>=0;e--)if(s>Le.daysInYearPassedMonth[a][e]){n.month=e+1,n.day=s-Le.daysInYearPassedMonth[a][e];break}return n.auto_normalize=!0,n}static fromStringv2(e){return new Le({year:parseInt(e.slice(0,4),10),month:parseInt(e.slice(5,7),10),day:parseInt(e.slice(8,10),10),isDate:!0})}static fromDateString(e){return new Le({year:$e(e.slice(0,4)),month:$e(e.slice(5,7)),day:$e(e.slice(8,10)),isDate:!0})}static fromDateTimeString(e,t){if(e.length<19)throw new Error('invalid date-time value: "'+e+'"');let r,s;"Z"===e.slice(-1)?r=je.utcTimezone:t&&(s=t.getParameter("tzid"),t.parent&&("standard"===t.parent.name||"daylight"===t.parent.name?r=je.localTimezone:s&&(r=t.parent.getTimeZoneByID(s))));const n={year:$e(e.slice(0,4)),month:$e(e.slice(5,7)),day:$e(e.slice(8,10)),hour:$e(e.slice(11,13)),minute:$e(e.slice(14,16)),second:$e(e.slice(17,19))};return s&&!r&&(n.timezone=s),new Le(n,r)}static fromString(e,t){return e.length>10?Le.fromDateTimeString(e,t):Le.fromDateString(e)}static fromJSDate(e,t){return(new Le).fromJSDate(e,t)}static fromData=function(e,t){return(new Le).fromData(e,t)};static now(){return Le.fromJSDate(new Date,!1)}static weekOneStarts(e,t){let r=Le.fromData({year:e,month:1,day:1,isDate:!0}),s=r.dayOfWeek(),n=t||Le.DEFAULT_WEEK_START;return s>Le.THURSDAY&&(r.day+=7),n>Le.THURSDAY&&(r.day-=7),r.day-=s-n,r}static getDominicalLetter(e){let t="GFEDCBA",r=(e+(e/4|0)+(e/400|0)-(e/100|0)-1)%7;return Le.isLeapYear(e)?t[(r+6)%7]+t[r]:t[r]}static#e=null;static get epochTime(){return this.#e||(this.#e=Le.fromData({year:1970,month:1,day:1,hour:0,minute:0,second:0,isDate:!1,timezone:"Z"})),this.#e}static _cmp_attr(e,t,r){return e[r]>t[r]?1:e[r]<t[r]?-1:0}static daysInYearPassedMonth=[[0,31,59,90,120,151,181,212,243,273,304,334,365],[0,31,60,91,121,152,182,213,244,274,305,335,366]];static SUNDAY=1;static MONDAY=2;static TUESDAY=3;static WEDNESDAY=4;static THURSDAY=5;static FRIDAY=6;static SATURDAY=7;static DEFAULT_WEEK_START=2;constructor(e,t){this.wrappedJSObject=this,this._time=Object.create(null),this._time.year=0,this._time.month=1,this._time.day=1,this._time.hour=0,this._time.minute=0,this._time.second=0,this._time.isDate=!1,this.fromData(e,t)}icalclass="icaltime";_cachedUnixTime=null;get icaltype(){return this.isDate?"date":"date-time"}zone=null;_pendingNormalization=!1;get year(){return this._getTimeAttr("year")}set year(e){this._setTimeAttr("year",e)}get month(){return this._getTimeAttr("month")}set month(e){this._setTimeAttr("month",e)}get day(){return this._getTimeAttr("day")}set day(e){this._setTimeAttr("day",e)}get hour(){return this._getTimeAttr("hour")}set hour(e){this._setTimeAttr("hour",e)}get minute(){return this._getTimeAttr("minute")}set minute(e){this._setTimeAttr("minute",e)}get second(){return this._getTimeAttr("second")}set second(e){this._setTimeAttr("second",e)}get isDate(){return this._getTimeAttr("isDate")}set isDate(e){this._setTimeAttr("isDate",e)}_getTimeAttr(e){return this._pendingNormalization&&(this._normalize(),this._pendingNormalization=!1),this._time[e]}_setTimeAttr(e,t){"isDate"===e&&t&&!this._time.isDate&&this.adjust(0,0,0,0),this._cachedUnixTime=null,this._pendingNormalization=!0,this._time[e]=t}clone(){return new Le(this._time,this.zone)}reset(){this.fromData(Le.epochTime),this.zone=je.utcTimezone}resetTo(e,t,r,s,n,a,i){this.fromData({year:e,month:t,day:r,hour:s,minute:n,second:a,zone:i})}fromJSDate(e,t){return e?t?(this.zone=je.utcTimezone,this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()):(this.zone=je.localTimezone,this.year=e.getFullYear(),this.month=e.getMonth()+1,this.day=e.getDate(),this.hour=e.getHours(),this.minute=e.getMinutes(),this.second=e.getSeconds()):this.reset(),this._cachedUnixTime=null,this}fromData(e,t){if(e)for(let[t,r]of Object.entries(e))"icaltype"!==t&&(this[t]=r);if(t&&(this.zone=t),e&&!("isDate"in e)?this.isDate=!("hour"in e):e&&"isDate"in e&&(this.isDate=e.isDate),e&&"timezone"in e){let t=He.get(e.timezone);this.zone=t||je.localTimezone}return e&&"zone"in e&&(this.zone=e.zone),this.zone||(this.zone=je.localTimezone),this._cachedUnixTime=null,this}dayOfWeek(e){let t=e||Le.SUNDAY,r=(this.year<<12)+(this.month<<8)+(this.day<<3)+t;if(r in Le._dowCache)return Le._dowCache[r];let s=this.day,n=this.month+(this.month<3?12:0),a=this.year-(this.month<3?1:0),i=s+a+Qe(26*(n+1)/10)+Qe(a/4);return i+=6*Qe(a/100)+Qe(a/400),i=(i+7-t)%7+1,Le._dowCache[r]=i,i}dayOfYear(){let e=Le.isLeapYear(this.year)?1:0;return Le.daysInYearPassedMonth[e][this.month-1]+this.day}startOfWeek(e){let t=e||Le.SUNDAY,r=this.clone();return r.day-=(this.dayOfWeek()+7-t)%7,r.isDate=!0,r.hour=0,r.minute=0,r.second=0,r}endOfWeek(e){let t=e||Le.SUNDAY,r=this.clone();return r.day+=(7-this.dayOfWeek()+t-Le.SUNDAY)%7,r.isDate=!0,r.hour=0,r.minute=0,r.second=0,r}startOfMonth(){let e=this.clone();return e.day=1,e.isDate=!0,e.hour=0,e.minute=0,e.second=0,e}endOfMonth(){let e=this.clone();return e.day=Le.daysInMonth(e.month,e.year),e.isDate=!0,e.hour=0,e.minute=0,e.second=0,e}startOfYear(){let e=this.clone();return e.day=1,e.month=1,e.isDate=!0,e.hour=0,e.minute=0,e.second=0,e}endOfYear(){let e=this.clone();return e.day=31,e.month=12,e.isDate=!0,e.hour=0,e.minute=0,e.second=0,e}startDoyWeek(e){let t=e||Le.SUNDAY,r=this.dayOfWeek()-t;return r<0&&(r+=7),this.dayOfYear()-r}getDominicalLetter(){return Le.getDominicalLetter(this.year)}nthWeekDay(e,t){let r,s=Le.daysInMonth(this.month,this.year),n=t,a=0,i=this.clone();if(n>=0){i.day=1,0!=n&&n--,a=i.day;let t=e-i.dayOfWeek();t<0&&(t+=7),a+=t,a-=e,r=e}else{i.day=s,n++,r=i.dayOfWeek()-e,r<0&&(r+=7),r=s-r}return r+=7*n,a+r}isNthWeekDay(e,t){let r=this.dayOfWeek();return 0===t&&r===e||this.nthWeekDay(e,t)===this.day}weekNumber(e){let t,r=(this.year<<12)+(this.month<<8)+(this.day<<3)+e;if(r in Le._wnCache)return Le._wnCache[r];let s=this.clone();s.isDate=!0;let n=this.year;12==s.month&&s.day>25?(t=Le.weekOneStarts(n+1,e),s.compare(t)<0?t=Le.weekOneStarts(n,e):n++):(t=Le.weekOneStarts(n,e),s.compare(t)<0&&(t=Le.weekOneStarts(--n,e)));let a=Qe(s.subtractDate(t).toSeconds()/86400/7)+1;return Le._wnCache[r]=a,a}addDuration(e){let t=e.isNegative?-1:1,r=this.second,s=this.minute,n=this.hour,a=this.day;r+=t*e.seconds,s+=t*e.minutes,n+=t*e.hours,a+=t*e.days,a+=7*t*e.weeks,this.second=r,this.minute=s,this.hour=n,this.day=a,this._cachedUnixTime=null}subtractDate(e){let t=this.toUnixTime()+this.utcOffset(),r=e.toUnixTime()+e.utcOffset();return Ne.fromSeconds(t-r)}subtractDateTz(e){let t=this.toUnixTime(),r=e.toUnixTime();return Ne.fromSeconds(t-r)}compare(e){if(e instanceof Ie)return-1*e.compare(this);{let t=this.toUnixTime(),r=e.toUnixTime();return t>r?1:r>t?-1:0}}compareDateOnlyTz(e,t){let r=this.convertToZone(t),s=e.convertToZone(t),n=0;return 0!=(n=Le._cmp_attr(r,s,"year"))||0!=(n=Le._cmp_attr(r,s,"month"))||(n=Le._cmp_attr(r,s,"day")),n}convertToZone(e){let t=this.clone(),r=this.zone.tzid==e.tzid;return this.isDate||r||je.convert_time(t,this.zone,e),t.zone=e,t}utcOffset(){return this.zone==je.localTimezone||this.zone==je.utcTimezone?0:this.zone.utcOffset(this)}toICALString(){let e=this.toString();return e.length>10?Mt.icalendar.value["date-time"].toICAL(e):Mt.icalendar.value.date.toICAL(e)}toString(){let e=this.year+"-"+Ge(this.month)+"-"+Ge(this.day);return this.isDate||(e+="T"+Ge(this.hour)+":"+Ge(this.minute)+":"+Ge(this.second),this.zone===je.utcTimezone&&(e+="Z")),e}toJSDate(){return this.zone==je.localTimezone?this.isDate?new Date(this.year,this.month-1,this.day):new Date(this.year,this.month-1,this.day,this.hour,this.minute,this.second,0):new Date(1e3*this.toUnixTime())}_normalize(){return this._time.isDate&&(this._time.hour=0,this._time.minute=0,this._time.second=0),this.adjust(0,0,0,0),this}adjust(e,t,r,s,n){let a,i,o,l,c,h,u,d=0,p=0,f=n||this._time;if(f.isDate||(o=f.second+s,f.second=o%60,a=Qe(o/60),f.second<0&&(f.second+=60,a--),l=f.minute+r+a,f.minute=l%60,i=Qe(l/60),f.minute<0&&(f.minute+=60,i--),c=f.hour+t+i,f.hour=c%24,d=Qe(c/24),f.hour<0&&(f.hour+=24,d--)),f.month>12?p=Qe((f.month-1)/12):f.month<1&&(p=Qe(f.month/12)-1),f.year+=p,f.month-=12*p,h=f.day+e+d,h>0)for(;u=Le.daysInMonth(f.month,f.year),!(h<=u);)f.month++,f.month>12&&(f.year++,f.month=1),h-=u;else for(;h<=0;)1==f.month?(f.year--,f.month=12):f.month--,h+=Le.daysInMonth(f.month,f.year);return f.day=h,this._cachedUnixTime=null,this}fromUnixTime(e){this.zone=je.utcTimezone;let t=new Date(1e3*e);this.year=t.getUTCFullYear(),this.month=t.getUTCMonth()+1,this.day=t.getUTCDate(),this._time.isDate?(this.hour=0,this.minute=0,this.second=0):(this.hour=t.getUTCHours(),this.minute=t.getUTCMinutes(),this.second=t.getUTCSeconds()),this._cachedUnixTime=null}toUnixTime(){if(null!==this._cachedUnixTime)return this._cachedUnixTime;let e=this.utcOffset(),t=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second-e);return this._cachedUnixTime=t/1e3,this._cachedUnixTime}toJSON(){let e,t=["year","month","day","hour","minute","second","isDate"],r=Object.create(null),s=0,n=t.length;for(;s<n;s++)e=t[s],r[e]=this[e];return this.zone&&(r.timezone=this.zone.tzid),r}}const Ue=/[^ \t]/,ke=":",Pe={"^'":'"',"^n":"\n","^^":"^"};function Be(e){let t={},r=t.component=[];if(t.stack=[r],Be._eachLine(e,(function(e,r){Be._handleContentLine(r,t)})),t.stack.length>1)throw new Me("invalid ical body. component began but did not end");return t=null,1==r.length?r[0]:r}Be.property=function(e,t){let r={component:[[],[]],designSet:t||Mt.defaultSet};return Be._handleContentLine(e,r),r.component[1][0]},Be.component=function(e){return Be(e)};class Me extends Error{name=this.constructor.name}Be.ParserError=Me,Be._handleContentLine=function(e,t){let r,s,n,a,i,o,l=e.indexOf(ke),c=e.indexOf(";"),h={};if(-1!==c&&-1!==l&&c>l&&(c=-1),-1!==c){if(n=e.slice(0,Math.max(0,c)).toLowerCase(),i=Be._parseParameters(e.slice(Math.max(0,c)),0,t.designSet),-1==i[2])throw new Me("Invalid parameters in '"+e+"'");let o;if(h=i[0],o="string"==typeof i[1]?i[1].length:i[1].reduce(((e,t)=>e+t.length),0),r=o+i[2]+c,-1===(s=e.slice(Math.max(0,r)).indexOf(ke)))throw new Me("Missing parameter value in '"+e+"'");a=e.slice(Math.max(0,r+s+1))}else{if(-1===l)throw new Me('invalid line (no token ";" or ":") "'+e+'"');if(n=e.slice(0,Math.max(0,l)).toLowerCase(),a=e.slice(Math.max(0,l+1)),"begin"===n){let e=[a.toLowerCase(),[],[]];return 1===t.stack.length?t.component.push(e):t.component[2].push(e),t.stack.push(t.component),t.component=e,void(t.designSet||(t.designSet=Mt.getDesignSet(t.component[0])))}if("end"===n)return void(t.component=t.stack.pop())}let u,d,p,f,m=!1,y=!1;t.designSet.propertyGroups&&-1!==n.indexOf(".")?(d=n.split("."),h.group=d[0],p=d[1]):p=n,p in t.designSet.property&&(u=t.designSet.property[p],"multiValue"in u&&(m=u.multiValue),"structuredValue"in u&&(y=u.structuredValue),a&&"detectType"in u&&(o=u.detectType(a))),o||(o="value"in h?h.value.toLowerCase():u?u.defaultType:"unknown"),delete h.value,m&&y?(a=Be._parseMultiValue(a,y,o,[],m,t.designSet,y),f=[p,h,o,a]):m?(f=[p,h,o],Be._parseMultiValue(a,m,o,f,null,t.designSet,!1)):y?(a=Be._parseMultiValue(a,y,o,[],null,t.designSet,y),f=[p,h,o,a]):(a=Be._parseValue(a,o,t.designSet,!1),f=[p,h,o,a]),"vcard"!==t.component[0]||0!==t.component[1].length||"version"===n&&"4.0"===a||(t.designSet=Mt.getDesignSet("vcard3")),t.component[1].push(f)},Be._parseValue=function(e,t,r,s){return t in r.value&&"fromICAL"in r.value[t]?r.value[t].fromICAL(e,s):e},Be._parseParameters=function(e,t,r){let s,n,a,i,o,l,c=t,h=0,u={},d=-1;for(;!1!==h&&-1!==(h=e.indexOf("=",h+1));){if(s=e.slice(c+1,h),0==s.length)throw new Me("Empty parameter name in '"+e+"'");if(n=s.toLowerCase(),l=!1,o=!1,i=n in r.param&&r.param[n].valueType?r.param[n].valueType:"text",n in r.param&&(o=r.param[n].multiValue,r.param[n].multiValueSeparateDQuote&&(l=Be._rfc6868Escape('"'+o+'"'))),'"'===e[h+1]){if(d=h+2,h=e.indexOf('"',d),o&&-1!=h){let t=!0;for(;t;)e[h+1]==o&&'"'==e[h+2]?h=e.indexOf('"',h+3):t=!1}if(-1===h)throw new Me('invalid line (no matching double quote) "'+e+'"');a=e.slice(d,h),c=e.indexOf(";",h);let t=e.indexOf(ke,h);(-1===c||-1!==t&&c>t)&&(h=!1)}else{d=h+1;let t=e.indexOf(";",d),r=e.indexOf(ke,d);-1!==r&&t>r?(t=r,h=!1):-1===t?(t=-1===r?e.length:r,h=!1):(c=t,h=t),a=e.slice(d,t)}const t=a.length;if(a=Be._rfc6868Escape(a),d+=t-a.length,o){let e=l||o;a=Be._parseMultiValue(a,e,i,[],null,r)}else a=Be._parseValue(a,i,r);o&&n in u?Array.isArray(u[n])?u[n].push(a):u[n]=[u[n],a]:u[n]=a}return[u,a,d]},Be._rfc6868Escape=function(e){return e.replace(/\^['n^]/g,(function(e){return Pe[e]}))},Be._parseMultiValue=function(e,t,r,s,n,a,i){let o,l=0,c=0;if(0===t.length)return e;for(;-1!==(l=qe(e,t,c));)o=e.slice(c,l),o=n?Be._parseMultiValue(o,n,r,[],null,a,i):Be._parseValue(o,r,a,i),s.push(o),c=l+t.length;return o=e.slice(c),o=n?Be._parseMultiValue(o,n,r,[],null,a,i):Be._parseValue(o,r,a,i),s.push(o),1==s.length?s[0]:s},Be._eachLine=function(e,t){let r,s,n,a=e.length,i=e.search(Ue),o=i;do{o=e.indexOf("\n",i)+1,n=o>1&&"\r"===e[o-2]?2:1,0===o&&(o=a,n=0),s=e[i]," "===s||"\t"===s?r+=e.slice(i+1,o-n):(r&&t(null,r),r=e.slice(i,o-n)),i=o}while(o!==a);r=r.trim(),r.length&&t(null,r)};const Re=["tzid","location","tznames","latitude","longitude"];class je{static _compare_change_fn(e,t){return e.year<t.year?-1:e.year>t.year?1:e.month<t.month?-1:e.month>t.month?1:e.day<t.day?-1:e.day>t.day?1:e.hour<t.hour?-1:e.hour>t.hour?1:e.minute<t.minute?-1:e.minute>t.minute?1:e.second<t.second?-1:e.second>t.second?1:0}static convert_time(e,t,r){if(e.isDate||t.tzid==r.tzid||t==je.localTimezone||r==je.localTimezone)return e.zone=r,e;let s=t.utcOffset(e);return e.adjust(0,0,0,-s),s=r.utcOffset(e),e.adjust(0,0,0,s),null}static fromData(e){return(new je).fromData(e)}static#t=null;static get utcTimezone(){return this.#t||(this.#t=je.fromData({tzid:"UTC"})),this.#t}static#r=null;static get localTimezone(){return this.#r||(this.#r=je.fromData({tzid:"floating"})),this.#r}static adjust_change(e,t,r,s,n){return Le.prototype.adjust.call(e,t,r,s,n,e)}static _minimumExpansionYear=-1;static EXTRA_COVERAGE=5;constructor(e){this.wrappedJSObject=this,this.fromData(e)}tzid="";location="";tznames="";latitude=0;longitude=0;component=null;expandedUntilYear=0;icalclass="icaltimezone";fromData(e){if(this.expandedUntilYear=0,this.changes=[],e instanceof $t)this.component=e;else{if(e&&"component"in e)if("string"==typeof e.component){let t=Be(e.component);this.component=new $t(t)}else e.component instanceof $t?this.component=e.component:this.component=null;for(let t of Re)e&&t in e&&(this[t]=e[t])}return this.component instanceof $t&&!this.tzid&&(this.tzid=this.component.getFirstPropertyValue("tzid")),this}utcOffset(e){if(this==je.utcTimezone||this==je.localTimezone)return 0;if(this._ensureCoverage(e.year),!this.changes.length)return 0;let t={year:e.year,month:e.month,day:e.day,hour:e.hour,minute:e.minute,second:e.second},r=this._findNearbyChange(t),s=-1,n=1;for(;;){let e=Ke(this.changes[r],!0);if(e.utcOffset<e.prevUtcOffset?je.adjust_change(e,0,0,0,e.utcOffset):je.adjust_change(e,0,0,0,e.prevUtcOffset),je._compare_change_fn(t,e)>=0?s=r:n=-1,-1==n&&-1!=s)break;if(r+=n,r<0)return 0;if(r>=this.changes.length)break}let a=this.changes[s];if(a.utcOffset-a.prevUtcOffset<0&&s>0){let e=Ke(a,!0);if(je.adjust_change(e,0,0,0,e.prevUtcOffset),je._compare_change_fn(t,e)<0){let e=this.changes[s-1],t=!1;a.is_daylight!=t&&e.is_daylight==t&&(a=e)}}return a.utcOffset}_findNearbyChange(e){let t=Ze(this.changes,e,je._compare_change_fn);return t>=this.changes.length?this.changes.length-1:t}_ensureCoverage(e){if(-1==je._minimumExpansionYear){let e=Le.now();je._minimumExpansionYear=e.year}let t=e;if(t<je._minimumExpansionYear&&(t=je._minimumExpansionYear),t+=je.EXTRA_COVERAGE,!this.changes.length||this.expandedUntilYear<e){let e=this.component.getAllSubcomponents(),r=e.length,s=0;for(;s<r;s++)this._expandComponent(e[s],t,this.changes);this.changes.sort(je._compare_change_fn),this.expandedUntilYear=t}}_expandComponent(e,t,r){if(!e.hasProperty("dtstart")||!e.hasProperty("tzoffsetto")||!e.hasProperty("tzoffsetfrom"))return null;let s,n=e.getFirstProperty("dtstart").getFirstValue();function a(e){return e.factor*(3600*e.hours+60*e.minutes)}function i(){let t={};return t.is_daylight="daylight"==e.name,t.utcOffset=a(e.getFirstProperty("tzoffsetto").getFirstValue()),t.prevUtcOffset=a(e.getFirstProperty("tzoffsetfrom").getFirstValue()),t}if(e.hasProperty("rrule")||e.hasProperty("rdate")){let a=e.getAllProperties("rdate");for(let e of a){let t=e.getFirstValue();s=i(),s.year=t.year,s.month=t.month,s.day=t.day,t.isDate?(s.hour=n.hour,s.minute=n.minute,s.second=n.second,n.zone!=je.utcTimezone&&je.adjust_change(s,0,0,0,-s.prevUtcOffset)):(s.hour=t.hour,s.minute=t.minute,s.second=t.second,t.zone!=je.utcTimezone&&je.adjust_change(s,0,0,0,-s.prevUtcOffset)),r.push(s)}let o=e.getFirstProperty("rrule");if(o){o=o.getFirstValue(),s=i(),o.until&&o.until.zone==je.utcTimezone&&(o.until.adjust(0,0,0,s.prevUtcOffset),o.until.zone=je.localTimezone);let e,a=o.iterator(n);for(;(e=a.next())&&(s=i(),!(e.year>t)&&e);)s.year=e.year,s.month=e.month,s.day=e.day,s.hour=e.hour,s.minute=e.minute,s.second=e.second,s.isDate=e.isDate,je.adjust_change(s,0,0,0,-s.prevUtcOffset),r.push(s)}}else s=i(),s.year=n.year,s.month=n.month,s.day=n.day,s.hour=n.hour,s.minute=n.minute,s.second=n.second,je.adjust_change(s,0,0,0,-s.prevUtcOffset),r.push(s);return r}toString(){return this.tznames?this.tznames:this.tzid}}let ze=null;const He={get count(){return null===ze?0:Object.keys(ze).length},reset:function(){ze=Object.create(null);let e=je.utcTimezone;ze.Z=e,ze.UTC=e,ze.GMT=e},_hard_reset:function(){ze=null},has:function(e){return null!==ze&&!!ze[e]},get:function(e){return null===ze&&this.reset(),ze[e]},register:function(e,t){if(null===ze&&this.reset(),"string"==typeof e&&t instanceof je&&([e,t]=[t,e]),t||(e instanceof je?t=e.tzid:"vtimezone"===e.name&&(t=(e=new je(e)).tzid)),!t)throw new TypeError("Neither a timezone nor a name was passed");if(!(e instanceof je))throw new TypeError("timezone must be ICAL.Timezone or ICAL.Component");ze[t]=e},remove:function(e){return null===ze?null:delete ze[e]}};function Fe(e){return"number"==typeof e&&isNaN(e)}function $e(e){let t=parseInt(e,10);if(Fe(t))throw new Error('Could not extract integer from "'+e+'"');return t}function We(e,t){if(void 0!==e)return e instanceof t?e:new t(e)}function qe(e,t,r){for(;-1!==(r=e.indexOf(t,r));){if(!(r>0&&"\\"===e[r-1]))return r;r+=1}return-1}function Ze(e,t,r){if(!e.length)return 0;let s,n,a=0,i=e.length-1;for(;a<=i;)if(s=a+Math.floor((i-a)/2),n=r(t,e[s]),n<0)i=s-1;else{if(!(n>0))break;a=s+1}return n<0?s:n>0?s+1:s}function Ke(e,t){if(e&&"object"==typeof e){if(e instanceof Date)return new Date(e.getTime());if("clone"in e)return e.clone();if(Array.isArray(e)){let r=[];for(let s=0;s<e.length;s++)r.push(t?Ke(e[s],!0):e[s]);return r}{let r={};for(let[s,n]of Object.entries(e))r[s]=t?Ke(n,!0):n;return r}}return e}function Je(e){let t="",r=e||"",s=0,n=0;for(;r.length;){let e=r.codePointAt(s);e<128?++n:n+=e<2048?2:e<65536?3:4,n<Kt.foldLength+1?s+=e>65535?2:1:(t+=Kt.newLineChar+" "+r.slice(0,Math.max(0,s)),r=r.slice(Math.max(0,s)),s=n=0)}return t.slice(Kt.newLineChar.length+1)}function Ge(e){switch("string"!=typeof e&&("number"==typeof e&&(e=parseInt(e)),e=String(e)),e.length){case 0:return"00";case 1:return"0"+e;default:return e}}function Qe(e){return e<0?Math.ceil(e):Math.floor(e)}function Xe(e,t){for(let r in e){let s=Object.getOwnPropertyDescriptor(e,r);s&&!Object.getOwnPropertyDescriptor(t,r)&&Object.defineProperty(t,r,s)}return t}var et=Object.freeze({__proto__:null,binsearchInsert:Ze,clone:Ke,extend:Xe,foldline:Je,formatClassType:We,isStrictlyNaN:Fe,pad2:Ge,strictParseInt:$e,trunc:Qe,unescapedIndexOf:qe,updateTimezones:function(e){let t,r,s,n,a;if(!e||"vcalendar"!==e.name)return e;for(t=e.getAllSubcomponents(),r=[],s={},a=0;a<t.length;a++)if("vtimezone"===t[a].name){s[t[a].getFirstProperty("tzid").getFirstValue()]=t[a]}else r=r.concat(t[a].getAllProperties());for(n={},a=0;a<r.length;a++){let e=r[a].getParameter("tzid");e&&(n[e]=!0)}for(let[t,r]of Object.entries(s))n[t]||e.removeSubcomponent(r);for(let t of Object.keys(n))!s[t]&&He.has(t)&&e.addSubcomponent(He.get(t).component);return e}});class tt{static fromString(e){let t={};return t.factor="+"===e[0]?1:-1,t.hours=$e(e.slice(1,3)),t.minutes=$e(e.slice(4,6)),new tt(t)}static fromSeconds(e){let t=new tt;return t.fromSeconds(e),t}constructor(e){this.fromData(e)}hours=0;minutes=0;factor=1;icaltype="utc-offset";clone(){return tt.fromSeconds(this.toSeconds())}fromData(e){if(e)for(let[t,r]of Object.entries(e))this[t]=r;this._normalize()}fromSeconds(e){let t=Math.abs(e);return this.factor=e<0?-1:1,this.hours=Qe(t/3600),t-=3600*this.hours,this.minutes=Qe(t/60),this}toSeconds(){return this.factor*(60*this.minutes+3600*this.hours)}compare(e){let t=this.toSeconds(),r=e.toSeconds();return(t>r)-(r>t)}_normalize(){let e=this.toSeconds(),t=this.factor;for(;e<-43200;)e+=97200;for(;e>50400;)e-=97200;this.fromSeconds(e),0==e&&(this.factor=t)}toICALString(){return Mt.icalendar.value["utc-offset"].toICAL(this.toString())}toString(){return(1==this.factor?"+":"-")+Ge(this.hours)+":"+Ge(this.minutes)}}class rt extends Le{static fromDateAndOrTimeString(e,t){function r(e,t,r){return e?$e(e.slice(t,t+r)):null}let s=e.split("T"),n=s[0],a=s[1],i=a?Mt.vcard.value.time._splitZone(a):[],o=i[0],l=i[1],c=n?n.length:0,h=l?l.length:0,u=n&&"-"==n[0]&&"-"==n[1],d=l&&"-"==l[0],p={year:u?null:r(n,0,4),month:!u||4!=c&&7!=c?7==c||10==c?r(n,5,2):null:r(n,2,2),day:5==c?r(n,3,2):7==c&&u?r(n,5,2):10==c?r(n,8,2):null,hour:d?null:r(l,0,2),minute:d&&3==h?r(l,1,2):h>4?r(l,d?1:3,2):null,second:4==h?r(l,2,2):6==h?r(l,4,2):8==h?r(l,6,2):null};return o="Z"==o?je.utcTimezone:o&&":"==o[3]?tt.fromString(o):null,new rt(p,o,t)}constructor(e,t,r){super(e,t),this.icaltype=r||"date-and-or-time"}icalclass="vcardtime";icaltype="date-and-or-time";clone(){return new rt(this._time,this.zone,this.icaltype)}_normalize(){return this}utcOffset(){return this.zone instanceof tt?this.zone.toSeconds():Le.prototype.utcOffset.apply(this,arguments)}toICALString(){return Mt.vcard.value[this.icaltype].toICAL(this.toString())}toString(){let e,t=this.year,r=this.month,s=this.day,n=this.hour,a=this.minute,i=this.second,o=null!==r,l=null!==s,c=null!==n,h=null!==a,u=null!==i,d=(null!==t?Ge(t)+(o||l?"-":""):o||l?"--":"")+(o?Ge(r):"")+(l?"-"+Ge(s):""),p=(c?Ge(n):"-")+(c&&h?":":"")+(h?Ge(a):"")+(c||h?"":"-")+(h&&u?":":"")+(u?Ge(i):"");if(this.zone===je.utcTimezone)e="Z";else if(this.zone instanceof tt)e=this.zone.toString();else if(this.zone===je.localTimezone)e="";else if(this.zone instanceof je){e=tt.fromSeconds(this.zone.utcOffset(this)).toString()}else e="";switch(this.icaltype){case"time":return p+e;case"date-and-or-time":case"date-time":return d+("--"==p?"":"T"+p+e);case"date":return d}return null}}class st{static _indexMap={BYSECOND:0,BYMINUTE:1,BYHOUR:2,BYDAY:3,BYMONTHDAY:4,BYYEARDAY:5,BYWEEKNO:6,BYMONTH:7,BYSETPOS:8};static _expandMap={SECONDLY:[1,1,1,1,1,1,1,1],MINUTELY:[2,1,1,1,1,1,1,1],HOURLY:[2,2,1,1,1,1,1,1],DAILY:[2,2,2,1,1,1,1,1],WEEKLY:[2,2,2,2,3,3,1,1],MONTHLY:[2,2,2,2,2,3,3,1],YEARLY:[2,2,2,2,2,2,2,2]};static UNKNOWN=0;static CONTRACT=1;static EXPAND=2;static ILLEGAL=3;constructor(e){this.fromData(e)}completed=!1;rule=null;dtstart=null;last=null;occurrence_number=0;by_indices=null;initialized=!1;by_data=null;days=null;days_index=0;fromData(e){if(this.rule=We(e.rule,ht),!this.rule)throw new Error("iterator requires a (ICAL.Recur) rule");if(this.dtstart=We(e.dtstart,Le),!this.dtstart)throw new Error("iterator requires a (ICAL.Time) dtstart");if(e.by_data?this.by_data=e.by_data:this.by_data=Ke(this.rule.parts,!0),e.occurrence_number&&(this.occurrence_number=e.occurrence_number),this.days=e.days||[],e.last&&(this.last=We(e.last,Le)),this.by_indices=e.by_indices,this.by_indices||(this.by_indices={BYSECOND:0,BYMINUTE:0,BYHOUR:0,BYDAY:0,BYMONTH:0,BYWEEKNO:0,BYMONTHDAY:0}),this.initialized=e.initialized||!1,!this.initialized)try{this.init()}catch(e){if(!(e instanceof nt))throw e;this.completed=!0}}init(){this.initialized=!0,this.last=this.dtstart.clone();let e=this.by_data;if("BYDAY"in e&&this.sort_byday_rules(e.BYDAY),"BYYEARDAY"in e&&("BYMONTH"in e||"BYWEEKNO"in e||"BYMONTHDAY"in e))throw new Error("Invalid BYYEARDAY rule");if("BYWEEKNO"in e&&"BYMONTHDAY"in e)throw new Error("BYWEEKNO does not fit to BYMONTHDAY");if("MONTHLY"==this.rule.freq&&("BYYEARDAY"in e||"BYWEEKNO"in e))throw new Error("For MONTHLY recurrences neither BYYEARDAY nor BYWEEKNO may appear");if("WEEKLY"==this.rule.freq&&("BYYEARDAY"in e||"BYMONTHDAY"in e))throw new Error("For WEEKLY recurrences neither BYMONTHDAY nor BYYEARDAY may appear");if("YEARLY"!=this.rule.freq&&"BYYEARDAY"in e)throw new Error("BYYEARDAY may only appear in YEARLY rules");if(this.last.second=this.setup_defaults("BYSECOND","SECONDLY",this.dtstart.second),this.last.minute=this.setup_defaults("BYMINUTE","MINUTELY",this.dtstart.minute),this.last.hour=this.setup_defaults("BYHOUR","HOURLY",this.dtstart.hour),this.last.day=this.setup_defaults("BYMONTHDAY","DAILY",this.dtstart.day),this.last.month=this.setup_defaults("BYMONTH","MONTHLY",this.dtstart.month),"WEEKLY"==this.rule.freq)if("BYDAY"in e){let[,t]=this.ruleDayOfWeek(e.BYDAY[0],this.rule.wkst),r=t-this.last.dayOfWeek(this.rule.wkst);(this.last.dayOfWeek(this.rule.wkst)<t&&r>=0||r<0)&&(this.last.day+=r)}else{let t=ht.numericDayToIcalDay(this.dtstart.dayOfWeek());e.BYDAY=[t]}if("YEARLY"==this.rule.freq){const e=this.rule.until?this.rule.until.year:2e4;for(;this.last.year<=e&&(this.expand_year_days(this.last.year),!(this.days.length>0));)this.increment_year(this.rule.interval);if(0==this.days.length)throw new nt;if(!(this._nextByYearDay()||this.next_year()||this.next_year()||this.next_year()))throw new nt}if("MONTHLY"==this.rule.freq)if(this.has_by_data("BYDAY")){let e=null,t=this.last.clone(),r=Le.daysInMonth(this.last.month,this.last.year);for(let s of this.by_data.BYDAY){this.last=t.clone();let[n,a]=this.ruleDayOfWeek(s),i=this.last.nthWeekDay(a,n);if(n>=6||n<=-6)throw new Error("Malformed values in BYDAY part");if(i>r||i<=0){if(e&&e.month==t.month)continue;for(;i>r||i<=0;)this.increment_month(),r=Le.daysInMonth(this.last.month,this.last.year),i=this.last.nthWeekDay(a,n)}this.last.day=i,(!e||this.last.compare(e)<0)&&(e=this.last.clone())}if(this.last=e.clone(),this.has_by_data("BYMONTHDAY")&&this._byDayAndMonthDay(!0),this.last.day>r||0==this.last.day)throw new Error("Malformed values in BYDAY part")}else if(this.has_by_data("BYMONTHDAY")){this.last.day=1;let e=this.normalizeByMonthDayRules(this.last.year,this.last.month,this.rule.parts.BYMONTHDAY).filter((e=>e>=this.last.day));if(e.length)this.last.day=e[0],this.by_data.BYMONTHDAY=e;else if(!this.next_month()&&!this.next_month()&&!this.next_month())throw new nt}}next(e=!1){let t,r=this.last?this.last.clone():null;if((this.rule.count&&this.occurrence_number>=this.rule.count||this.rule.until&&this.last.compare(this.rule.until)>0)&&(this.completed=!0),this.completed)return null;if(0==this.occurrence_number&&this.last.compare(this.dtstart)>=0)return this.occurrence_number++,this.last;let s=0;do{switch(t=1,this.rule.freq){case"SECONDLY":this.next_second();break;case"MINUTELY":this.next_minute();break;case"HOURLY":this.next_hour();break;case"DAILY":this.next_day();break;case"WEEKLY":this.next_week();break;case"MONTHLY":if(t=this.next_month(),t)s=0;else if(336==++s)return this.completed=!0,null;break;case"YEARLY":if(t=this.next_year(),t)s=0;else if(28==++s)return this.completed=!0,null;break;default:return null}}while(!this.check_contracting_rules()||this.last.compare(this.dtstart)<0||!t);if(0==this.last.compare(r)){if(e)throw new Error("Same occurrence found twice, protecting you from death by recursion");this.next(!0)}return this.rule.until&&this.last.compare(this.rule.until)>0?(this.completed=!0,null):(this.occurrence_number++,this.last)}next_second(){return this.next_generic("BYSECOND","SECONDLY","second","minute")}increment_second(e){return this.increment_generic(e,"second",60,"minute")}next_minute(){return this.next_generic("BYMINUTE","MINUTELY","minute","hour","next_second")}increment_minute(e){return this.increment_generic(e,"minute",60,"hour")}next_hour(){return this.next_generic("BYHOUR","HOURLY","hour","monthday","next_minute")}increment_hour(e){this.increment_generic(e,"hour",24,"monthday")}next_day(){let e="DAILY"==this.rule.freq;return 0==this.next_hour()||(e?this.increment_monthday(this.rule.interval):this.increment_monthday(1)),0}next_week(){let e=0;if(0==this.next_weekday_by_week())return e;if(this.has_by_data("BYWEEKNO")){this.by_indices.BYWEEKNO++,this.by_indices.BYWEEKNO==this.by_data.BYWEEKNO.length&&(this.by_indices.BYWEEKNO=0,e=1),this.last.month=1,this.last.day=1;let t=this.by_data.BYWEEKNO[this.by_indices.BYWEEKNO];this.last.day+=7*t,e&&this.increment_year(1)}else this.increment_monthday(7*this.rule.interval);return e}normalizeByMonthDayRules(e,t,r){let s,n=Le.daysInMonth(t,e),a=[],i=0,o=r.length;for(;i<o;i++){if(s=parseInt(r[i],10),isNaN(s))throw new Error("Invalid BYMONTHDAY value");if(!(Math.abs(s)>n)){if(s<0)s=n+(s+1);else if(0===s)continue;-1===a.indexOf(s)&&a.push(s)}}return a.sort((function(e,t){return e-t}))}_byDayAndMonthDay(e){let t,r,s,n,a=this.by_data.BYDAY,i=0,o=a.length,l=0,c=this,h=this.last.day;function u(){for(n=Le.daysInMonth(c.last.month,c.last.year),t=c.normalizeByMonthDayRules(c.last.year,c.last.month,c.by_data.BYMONTHDAY),s=t.length;t[i]<=h&&(!e||t[i]!=h)&&i<s-1;)i++}function d(){h=0,c.increment_month(),i=0,u()}u(),e&&(h-=1);let p=48;for(;!l&&p;){if(p--,r=h+1,r>n){d();continue}let e=t[i++];if(e>=r){h=e;for(let e=0;e<o;e++){let t=this.ruleDayOfWeek(a[e]),r=t[0],s=t[1];if(this.last.day=h,this.last.isNthWeekDay(s,r)){l=1;break}}l||i!==s||d()}else d()}if(p<=0)throw new Error("Malformed values in BYDAY combined with BYMONTHDAY parts");return l}next_month(){let e=1;if(0==this.next_hour())return e;if(this.has_by_data("BYDAY")&&this.has_by_data("BYMONTHDAY"))e=this._byDayAndMonthDay();else if(this.has_by_data("BYDAY")){let t,r=Le.daysInMonth(this.last.month,this.last.year),s=0,n=0;if(this.has_by_data("BYSETPOS")){let e=this.last.day;for(let t=1;t<=r;t++)this.last.day=t,this.is_day_in_byday(this.last)&&(n++,t<=e&&s++);this.last.day=e}for(e=0,t=this.last.day+1;t<=r;t++)if(this.last.day=t,this.is_day_in_byday(this.last)&&(!this.has_by_data("BYSETPOS")||this.check_set_position(++s)||this.check_set_position(s-n-1))){e=1;break}t>r&&(this.last.day=1,this.increment_month(),this.is_day_in_byday(this.last)?this.has_by_data("BYSETPOS")&&!this.check_set_position(1)||(e=1):e=0)}else if(this.has_by_data("BYMONTHDAY")){if(this.by_indices.BYMONTHDAY++,this.by_indices.BYMONTHDAY>=this.by_data.BYMONTHDAY.length&&(this.by_indices.BYMONTHDAY=0,this.increment_month(),this.by_indices.BYMONTHDAY>=this.by_data.BYMONTHDAY.length))return 0;let t=Le.daysInMonth(this.last.month,this.last.year),r=this.by_data.BYMONTHDAY[this.by_indices.BYMONTHDAY];r<0&&(r=t+r+1),r>t?(this.last.day=1,e=this.is_day_in_byday(this.last)):this.last.day=r}else{this.increment_month();let t=Le.daysInMonth(this.last.month,this.last.year);this.by_data.BYMONTHDAY[0]>t?e=0:this.last.day=this.by_data.BYMONTHDAY[0]}return e}next_weekday_by_week(){let e=0;if(0==this.next_hour())return e;if(!this.has_by_data("BYDAY"))return 1;for(;;){let t=new Le;this.by_indices.BYDAY++,this.by_indices.BYDAY==Object.keys(this.by_data.BYDAY).length&&(this.by_indices.BYDAY=0,e=1);let r=this.by_data.BYDAY[this.by_indices.BYDAY],s=this.ruleDayOfWeek(r)[1];s-=this.rule.wkst,s<0&&(s+=7),t.year=this.last.year,t.month=this.last.month,t.day=this.last.day;let n=t.startDoyWeek(this.rule.wkst);if(s+n<1&&!e)continue;let a=Le.fromDayOfYear(n+s,this.last.year);return this.last.year=a.year,this.last.month=a.month,this.last.day=a.day,e}}next_year(){return 0==this.next_hour()?0:0!=this.days.length&&++this.days_index!=this.days.length||(this.days_index=0,this.increment_year(this.rule.interval),this.has_by_data("BYMONTHDAY")&&(this.by_data.BYMONTHDAY=this.normalizeByMonthDayRules(this.last.year,this.last.month,this.rule.parts.BYMONTHDAY)),this.expand_year_days(this.last.year),0!=this.days.length)?this._nextByYearDay():0}_nextByYearDay(){let e=this.days[this.days_index],t=this.last.year;if(366==Math.abs(e)&&!Le.isLeapYear(this.last.year))return 0;e<1&&(e+=1,t+=1);let r=Le.fromDayOfYear(e,t);return this.last.day=r.day,this.last.month=r.month,1}ruleDayOfWeek(e,t){let r=e.match(/([+-]?[0-9])?(MO|TU|WE|TH|FR|SA|SU)/);if(r){return[parseInt(r[1]||0,10),e=ht.icalDayToNumericDay(r[2],t)]}return[0,0]}next_generic(e,t,r,s,n){let a=e in this.by_data,i=this.rule.freq==t,o=0;if(n&&0==this[n]())return o;if(a){this.by_indices[e]++;let t=this.by_data[e];this.by_indices[e]==t.length&&(this.by_indices[e]=0,o=1),this.last[r]=t[this.by_indices[e]]}else i&&this["increment_"+r](this.rule.interval);return a&&o&&i&&this["increment_"+s](1),o}increment_monthday(e){for(let t=0;t<e;t++){let e=Le.daysInMonth(this.last.month,this.last.year);this.last.day++,this.last.day>e&&(this.last.day-=e,this.increment_month())}}increment_month(){if(this.last.day=1,this.has_by_data("BYMONTH"))this.by_indices.BYMONTH++,this.by_indices.BYMONTH==this.by_data.BYMONTH.length&&(this.by_indices.BYMONTH=0,this.increment_year(1)),this.last.month=this.by_data.BYMONTH[this.by_indices.BYMONTH];else{"MONTHLY"==this.rule.freq?this.last.month+=this.rule.interval:this.last.month++,this.last.month--;let e=Qe(this.last.month/12);this.last.month%=12,this.last.month++,0!=e&&this.increment_year(e)}this.has_by_data("BYMONTHDAY")&&(this.by_data.BYMONTHDAY=this.normalizeByMonthDayRules(this.last.year,this.last.month,this.rule.parts.BYMONTHDAY))}increment_year(e){this.last.day=1,this.last.year+=e}increment_generic(e,t,r,s){this.last[t]+=e;let n=Qe(this.last[t]/r);this.last[t]%=r,0!=n&&this["increment_"+s](n)}has_by_data(e){return e in this.rule.parts}expand_year_days(e){let t=new Le;this.days=[];let r={},s=["BYDAY","BYWEEKNO","BYMONTHDAY","BYMONTH","BYYEARDAY"];for(let e of s)e in this.rule.parts&&(r[e]=this.rule.parts[e]);if("BYMONTH"in r&&"BYWEEKNO"in r){let s=1,n={};t.year=e,t.isDate=!0;for(let r=0;r<this.by_data.BYMONTH.length;r++){let s=this.by_data.BYMONTH[r];t.month=s,t.day=1;let a=t.weekNumber(this.rule.wkst);t.day=Le.daysInMonth(s,e);let i=t.weekNumber(this.rule.wkst);for(r=a;r<i;r++)n[r]=1}for(let e=0;e<this.by_data.BYWEEKNO.length&&s;e++){this.by_data.BYWEEKNO[e]<52?s&=n[e]:s=0}s?delete r.BYMONTH:delete r.BYWEEKNO}let n=Object.keys(r).length;if(0==n){let e=this.dtstart.clone();e.year=this.last.year,this.days.push(e.dayOfYear())}else if(1==n&&"BYMONTH"in r)for(let t of this.by_data.BYMONTH){let r=this.dtstart.clone();r.year=e,r.month=t,r.isDate=!0,this.days.push(r.dayOfYear())}else if(1==n&&"BYMONTHDAY"in r)for(let t of this.by_data.BYMONTHDAY){let r=this.dtstart.clone();if(t<0){t=t+Le.daysInMonth(r.month,e)+1}r.day=t,r.year=e,r.isDate=!0,this.days.push(r.dayOfYear())}else if(2==n&&"BYMONTHDAY"in r&&"BYMONTH"in r)for(let r of this.by_data.BYMONTH){let s=Le.daysInMonth(r,e);for(let n of this.by_data.BYMONTHDAY)n<0&&(n=n+s+1),t.day=n,t.month=r,t.year=e,t.isDate=!0,this.days.push(t.dayOfYear())}else if(1==n&&"BYWEEKNO"in r);else if(2==n&&"BYWEEKNO"in r&&"BYMONTHDAY"in r);else if(1==n&&"BYDAY"in r)this.days=this.days.concat(this.expand_by_day(e));else if(2==n&&"BYDAY"in r&&"BYMONTH"in r){for(let r of this.by_data.BYMONTH){let s=Le.daysInMonth(r,e);t.year=e,t.month=r,t.day=1,t.isDate=!0;let n=t.dayOfWeek(),a=t.dayOfYear()-1;t.day=s;let i=t.dayOfWeek();if(this.has_by_data("BYSETPOS")){let e=[];for(let r=1;r<=s;r++)t.day=r,this.is_day_in_byday(t)&&e.push(r);for(let t=0;t<e.length;t++)(this.check_set_position(t+1)||this.check_set_position(t-e.length))&&this.days.push(a+e[t])}else for(let e of this.by_data.BYDAY){let t,r=this.ruleDayOfWeek(e),o=r[0],l=r[1],c=(l+7-n)%7+1,h=s-(i+7-l)%7;if(0==o)for(let e=c;e<=s;e+=7)this.days.push(a+e);else o>0?(t=c+7*(o-1),t<=s&&this.days.push(a+t)):(t=h+7*(o+1),t>0&&this.days.push(a+t))}}this.days.sort((function(e,t){return e-t}))}else if(2==n&&"BYDAY"in r&&"BYMONTHDAY"in r){let t=this.expand_by_day(e);for(let r of t){let t=Le.fromDayOfYear(r,e);this.by_data.BYMONTHDAY.indexOf(t.day)>=0&&this.days.push(r)}}else if(3==n&&"BYDAY"in r&&"BYMONTHDAY"in r&&"BYMONTH"in r){let t=this.expand_by_day(e);for(let r of t){let t=Le.fromDayOfYear(r,e);this.by_data.BYMONTH.indexOf(t.month)>=0&&this.by_data.BYMONTHDAY.indexOf(t.day)>=0&&this.days.push(r)}}else if(2==n&&"BYDAY"in r&&"BYWEEKNO"in r){let t=this.expand_by_day(e);for(let r of t){let t=Le.fromDayOfYear(r,e).weekNumber(this.rule.wkst);this.by_data.BYWEEKNO.indexOf(t)&&this.days.push(r)}}else if(3==n&&"BYDAY"in r&&"BYWEEKNO"in r&&"BYMONTHDAY"in r);else if(1==n&&"BYYEARDAY"in r)this.days=this.days.concat(this.by_data.BYYEARDAY);else if(2==n&&"BYYEARDAY"in r&&"BYDAY"in r){let t=Le.isLeapYear(e)?366:365,r=new Set(this.expand_by_day(e));for(let e of this.by_data.BYYEARDAY)e<0&&(e+=t+1),r.has(e)&&this.days.push(e)}else this.days=[];let a=Le.isLeapYear(e)?366:365;return this.days.sort(((e,t)=>(e<0&&(e+=a+1),t<0&&(t+=a+1),e-t))),0}expand_by_day(e){let t=[],r=this.last.clone();r.year=e,r.month=1,r.day=1,r.isDate=!0;let s=r.dayOfWeek();r.month=12,r.day=31,r.isDate=!0;let n=r.dayOfWeek(),a=r.dayOfYear();for(let e of this.by_data.BYDAY){let r=this.ruleDayOfWeek(e),i=r[0],o=r[1];if(0==i){for(let e=(o+7-s)%7+1;e<=a;e+=7)t.push(e)}else if(i>0){let e;e=o>=s?o-s+1:o-s+8,t.push(e+7*(i-1))}else{let e;i=-i,e=o<=n?a-n+o:a-n+o-7,t.push(e-7*(i-1))}}return t}is_day_in_byday(e){if(this.by_data.BYDAY)for(let t of this.by_data.BYDAY){let r=this.ruleDayOfWeek(t),s=r[0],n=r[1],a=e.dayOfWeek();if(0==s&&n==a||e.nthWeekDay(n,s)==e.day)return 1}return 0}check_set_position(e){if(this.has_by_data("BYSETPOS")){return-1!==this.by_data.BYSETPOS.indexOf(e)}return!1}sort_byday_rules(e){for(let t=0;t<e.length;t++)for(let r=0;r<t;r++){if(this.ruleDayOfWeek(e[r],this.rule.wkst)[1]>this.ruleDayOfWeek(e[t],this.rule.wkst)[1]){let s=e[t];e[t]=e[r],e[r]=s}}}check_contract_restriction(e,t){let r=st._indexMap[e],s=st._expandMap[this.rule.freq][r],n=!1;if(e in this.by_data&&s==st.CONTRACT){let r=this.by_data[e];for(let e of r)if(e==t){n=!0;break}}else n=!0;return n}check_contracting_rules(){let e=this.last.dayOfWeek(),t=this.last.weekNumber(this.rule.wkst),r=this.last.dayOfYear();return this.check_contract_restriction("BYSECOND",this.last.second)&&this.check_contract_restriction("BYMINUTE",this.last.minute)&&this.check_contract_restriction("BYHOUR",this.last.hour)&&this.check_contract_restriction("BYDAY",ht.numericDayToIcalDay(e))&&this.check_contract_restriction("BYWEEKNO",t)&&this.check_contract_restriction("BYMONTHDAY",this.last.day)&&this.check_contract_restriction("BYMONTH",this.last.month)&&this.check_contract_restriction("BYYEARDAY",r)}setup_defaults(e,t,r){let s=st._indexMap[e];return st._expandMap[this.rule.freq][s]!=st.CONTRACT&&(e in this.by_data||(this.by_data[e]=[r]),this.rule.freq!=t)?this.by_data[e][0]:r}toJSON(){let e=Object.create(null);return e.initialized=this.initialized,e.rule=this.rule.toJSON(),e.dtstart=this.dtstart.toJSON(),e.by_data=this.by_data,e.days=this.days,e.last=this.last.toJSON(),e.by_indices=this.by_indices,e.occurrence_number=this.occurrence_number,e}}class nt extends Error{constructor(){super("Recurrence rule has no valid occurrences")}}const at=/^(SU|MO|TU|WE|TH|FR|SA)$/,it=/^([+-])?(5[0-3]|[1-4][0-9]|[1-9])?(SU|MO|TU|WE|TH|FR|SA)$/,ot={SU:Le.SUNDAY,MO:Le.MONDAY,TU:Le.TUESDAY,WE:Le.WEDNESDAY,TH:Le.THURSDAY,FR:Le.FRIDAY,SA:Le.SATURDAY},lt=Object.fromEntries(Object.entries(ot).map((e=>e.reverse()))),ct=["SECONDLY","MINUTELY","HOURLY","DAILY","WEEKLY","MONTHLY","YEARLY"];class ht{static fromString(e){let t=this._stringToData(e,!1);return new ht(t)}static fromData(e){return new ht(e)}static _stringToData(e,t){let r=Object.create(null),s=e.split(";"),n=s.length;for(let e=0;e<n;e++){let n=s[e].split("="),a=n[0].toUpperCase(),i=n[0].toLowerCase(),o=t?i:a,l=n[1];if(a in pt){let e=l.split(","),t=new Set;for(let r of e)t.add(pt[a](r));e=[...t],r[o]=1==e.length?e[0]:e}else a in dt?dt[a](l,r,t):r[i]=l}return r}static icalDayToNumericDay(e,t){let r=t||Le.SUNDAY;return(ot[e]-r+7)%7+1}static numericDayToIcalDay(e,t){let r=e+(t||Le.SUNDAY)-Le.SUNDAY;return r>7&&(r-=7),lt[r]}constructor(e){this.wrappedJSObject=this,this.parts={},e&&"object"==typeof e&&this.fromData(e)}parts=null;interval=1;wkst=Le.MONDAY;until=null;count=null;freq=null;icalclass="icalrecur";icaltype="recur";iterator(e){return new st({rule:this,dtstart:e})}clone(){return new ht(this.toJSON())}isFinite(){return!(!this.count&&!this.until)}isByCount(){return!(!this.count||this.until)}addComponent(e,t){let r=e.toUpperCase();r in this.parts?this.parts[r].push(t):this.parts[r]=[t]}setComponent(e,t){this.parts[e.toUpperCase()]=t.slice()}getComponent(e){let t=e.toUpperCase();return t in this.parts?this.parts[t].slice():[]}getNextOccurrence(e,t){let r,s=this.iterator(e);do{r=s.next()}while(r&&r.compare(t)<=0);return r&&t.zone&&(r.zone=t.zone),r}fromData(e){for(let t in e){let r=t.toUpperCase();r in pt?Array.isArray(e[t])?this.parts[r]=e[t]:this.parts[r]=[e[t]]:this[t]=e[t]}this.interval&&"number"!=typeof this.interval&&dt.INTERVAL(this.interval,this),this.wkst&&"number"!=typeof this.wkst&&(this.wkst=ht.icalDayToNumericDay(this.wkst)),!this.until||this.until instanceof Le||(this.until=Le.fromString(this.until))}toJSON(){let e=Object.create(null);e.freq=this.freq,this.count&&(e.count=this.count),this.interval>1&&(e.interval=this.interval);for(let[t,r]of Object.entries(this.parts))Array.isArray(r)&&1==r.length?e[t.toLowerCase()]=r[0]:e[t.toLowerCase()]=Ke(r);return this.until&&(e.until=this.until.toString()),"wkst"in this&&this.wkst!==Le.DEFAULT_WEEK_START&&(e.wkst=ht.numericDayToIcalDay(this.wkst)),e}toString(){let e="FREQ="+this.freq;this.count&&(e+=";COUNT="+this.count),this.interval>1&&(e+=";INTERVAL="+this.interval);for(let[t,r]of Object.entries(this.parts))e+=";"+t+"="+r;return this.until&&(e+=";UNTIL="+this.until.toICALString()),"wkst"in this&&this.wkst!==Le.DEFAULT_WEEK_START&&(e+=";WKST="+ht.numericDayToIcalDay(this.wkst)),e}}function ut(e,t,r,s){let n=s;if("+"===s[0]&&(n=s.slice(1)),n=$e(n),void 0!==t&&s<t)throw new Error(e+': invalid value "'+s+'" must be > '+t);if(void 0!==r&&s>r)throw new Error(e+': invalid value "'+s+'" must be < '+t);return n}const dt={FREQ:function(e,t,r){if(-1===ct.indexOf(e))throw new Error('invalid frequency "'+e+'" expected: "'+ct.join(", ")+'"');t.freq=e},COUNT:function(e,t,r){t.count=$e(e)},INTERVAL:function(e,t,r){t.interval=$e(e),t.interval<1&&(t.interval=1)},UNTIL:function(e,t,r){e.length>10?t.until=Mt.icalendar.value["date-time"].fromICAL(e):t.until=Mt.icalendar.value.date.fromICAL(e),r||(t.until=Le.fromString(t.until))},WKST:function(e,t,r){if(!at.test(e))throw new Error('invalid WKST value "'+e+'"');t.wkst=ht.icalDayToNumericDay(e)}},pt={BYSECOND:ut.bind(void 0,"BYSECOND",0,60),BYMINUTE:ut.bind(void 0,"BYMINUTE",0,59),BYHOUR:ut.bind(void 0,"BYHOUR",0,23),BYDAY:function(e){if(it.test(e))return e;throw new Error('invalid BYDAY value "'+e+'"')},BYMONTHDAY:ut.bind(void 0,"BYMONTHDAY",-31,31),BYYEARDAY:ut.bind(void 0,"BYYEARDAY",-366,366),BYWEEKNO:ut.bind(void 0,"BYWEEKNO",-53,53),BYMONTH:ut.bind(void 0,"BYMONTH",1,12),BYSETPOS:ut.bind(void 0,"BYSETPOS",-366,366)},ft=/\\\\|\\,|\\[Nn]/g,mt=/\\|,|\n/g;function yt(e,t){return{matches:/.*/,fromICAL:function(t,r){return function(e,t,r){if(-1===e.indexOf("\\"))return e;r&&(t=new RegExp(t.source+"|\\\\"+r,t.flags));return e.replace(t,St)}(t,e,r)},toICAL:function(e,r){let s=t;return r&&(s=new RegExp(s.source+"|"+r,s.flags)),e.replace(s,(function(e){switch(e){case"\\":return"\\\\";case";":return"\\;";case",":return"\\,";case"\n":return"\\n";default:return e}}))}}}const gt={defaultType:"text"},Dt={defaultType:"text",multiValue:","},At={defaultType:"text",structuredValue:";"},_t={defaultType:"integer"},Ot={defaultType:"date-time",allowedTypes:["date-time","date"]},vt={defaultType:"date-time"},Tt={defaultType:"uri"},xt={defaultType:"utc-offset"},wt={defaultType:"recur"},bt={defaultType:"date-and-or-time",allowedTypes:["date-time","date","text"]};function St(e){switch(e){case"\\\\":return"\\";case"\\;":return";";case"\\,":return",";case"\\n":case"\\N":return"\n";default:return e}}let Ct={categories:Dt,url:Tt,version:gt,uid:gt},Et={boolean:{values:["TRUE","FALSE"],fromICAL:function(e){return"TRUE"===e},toICAL:function(e){return e?"TRUE":"FALSE"}},float:{matches:/^[+-]?\d+\.\d+$/,fromICAL:function(e){let t=parseFloat(e);return Fe(t)?0:t},toICAL:function(e){return String(e)}},integer:{fromICAL:function(e){let t=parseInt(e);return Fe(t)?0:t},toICAL:function(e){return String(e)}},"utc-offset":{toICAL:function(e){return e.length<7?e.slice(0,3)+e.slice(4,6):e.slice(0,3)+e.slice(4,6)+e.slice(7,9)},fromICAL:function(e){return e.length<6?e.slice(0,3)+":"+e.slice(3,5):e.slice(0,3)+":"+e.slice(3,5)+":"+e.slice(5,7)},decorate:function(e){return tt.fromString(e)},undecorate:function(e){return e.toString()}}};const Vt=Xe(Et,{text:yt(/\\\\|\\;|\\,|\\[Nn]/g,/\\|;|,|\n/g),uri:{},binary:{decorate:function(e){return Ce.fromString(e)},undecorate:function(e){return e.toString()}},"cal-address":{},date:{decorate:function(e,t){return Le.fromDateString(e,t)},undecorate:function(e){return e.toString()},fromICAL:function(e){return e.slice(0,4)+"-"+e.slice(4,6)+"-"+e.slice(6,8)},toICAL:function(e){let t=e.length;return 10==t?e.slice(0,4)+e.slice(5,7)+e.slice(8,10):t>=19?Vt["date-time"].toICAL(e):e}},"date-time":{fromICAL:function(e){{let t=e.slice(0,4)+"-"+e.slice(4,6)+"-"+e.slice(6,8)+"T"+e.slice(9,11)+":"+e.slice(11,13)+":"+e.slice(13,15);return e[15]&&"Z"===e[15]&&(t+="Z"),t}},toICAL:function(e){if(e.length>=19){let t=e.slice(0,4)+e.slice(5,7)+e.slice(8,13)+e.slice(14,16)+e.slice(17,19);return e[19]&&"Z"===e[19]&&(t+="Z"),t}return e},decorate:function(e,t){return Le.fromDateTimeString(e,t)},undecorate:function(e){return e.toString()}},duration:{decorate:function(e){return Ne.fromString(e)},undecorate:function(e){return e.toString()}},period:{fromICAL:function(e){let t=e.split("/");return t[0]=Vt["date-time"].fromICAL(t[0]),Ne.isValueString(t[1])||(t[1]=Vt["date-time"].fromICAL(t[1])),t},toICAL:function(e){return(e=e.slice())[0]=Vt["date-time"].toICAL(e[0]),Ne.isValueString(e[1])||(e[1]=Vt["date-time"].toICAL(e[1])),e.join("/")},decorate:function(e,t){return Ie.fromJSON(e,t,!1)},undecorate:function(e){return e.toJSON()}},recur:{fromICAL:function(e){return ht._stringToData(e,!0)},toICAL:function(e){let t="";for(let[r,s]of Object.entries(e))"until"==r?s=s.length>10?Vt["date-time"].toICAL(s):Vt.date.toICAL(s):"wkst"==r?"number"==typeof s&&(s=ht.numericDayToIcalDay(s)):Array.isArray(s)&&(s=s.join(",")),t+=r.toUpperCase()+"="+s+";";return t.slice(0,Math.max(0,t.length-1))},decorate:function(e){return ht.fromData(e)},undecorate:function(e){return e.toJSON()}},time:{fromICAL:function(e){if(e.length<6)return e;let t=e.slice(0,2)+":"+e.slice(2,4)+":"+e.slice(4,6);return"Z"===e[6]&&(t+="Z"),t},toICAL:function(e){if(e.length<8)return e;let t=e.slice(0,2)+e.slice(3,5)+e.slice(6,8);return"Z"===e[8]&&(t+="Z"),t}}});let Nt=Xe(Ct,{action:gt,attach:{defaultType:"uri"},attendee:{defaultType:"cal-address"},calscale:gt,class:gt,comment:gt,completed:vt,contact:gt,created:vt,description:gt,dtend:Ot,dtstamp:vt,dtstart:Ot,due:Ot,duration:{defaultType:"duration"},exdate:{defaultType:"date-time",allowedTypes:["date-time","date"],multiValue:","},exrule:wt,freebusy:{defaultType:"period",multiValue:","},geo:{defaultType:"float",structuredValue:";"},"last-modified":vt,location:gt,method:gt,organizer:{defaultType:"cal-address"},"percent-complete":_t,priority:_t,prodid:gt,"related-to":gt,repeat:_t,rdate:{defaultType:"date-time",allowedTypes:["date-time","date","period"],multiValue:",",detectType:function(e){return-1!==e.indexOf("/")?"period":-1===e.indexOf("T")?"date":"date-time"}},"recurrence-id":Ot,resources:Dt,"request-status":At,rrule:wt,sequence:_t,status:gt,summary:gt,transp:gt,trigger:{defaultType:"duration",allowedTypes:["duration","date-time"]},tzoffsetfrom:xt,tzoffsetto:xt,tzurl:Tt,tzid:gt,tzname:gt});const Yt=Xe(Et,{text:yt(ft,mt),uri:yt(ft,mt),date:{decorate:function(e){return rt.fromDateAndOrTimeString(e,"date")},undecorate:function(e){return e.toString()},fromICAL:function(e){return 8==e.length?Vt.date.fromICAL(e):"-"==e[0]&&6==e.length?e.slice(0,4)+"-"+e.slice(4):e},toICAL:function(e){return 10==e.length?Vt.date.toICAL(e):"-"==e[0]&&7==e.length?e.slice(0,4)+e.slice(5):e}},time:{decorate:function(e){return rt.fromDateAndOrTimeString("T"+e,"time")},undecorate:function(e){return e.toString()},fromICAL:function(e){let t=Yt.time._splitZone(e,!0),r=t[0],s=t[1];return 6==s.length?s=s.slice(0,2)+":"+s.slice(2,4)+":"+s.slice(4,6):4==s.length&&"-"!=s[0]?s=s.slice(0,2)+":"+s.slice(2,4):5==s.length&&(s=s.slice(0,3)+":"+s.slice(3,5)),5!=r.length||"-"!=r[0]&&"+"!=r[0]||(r=r.slice(0,3)+":"+r.slice(3)),s+r},toICAL:function(e){let t=Yt.time._splitZone(e),r=t[0],s=t[1];return 8==s.length?s=s.slice(0,2)+s.slice(3,5)+s.slice(6,8):5==s.length&&"-"!=s[0]?s=s.slice(0,2)+s.slice(3,5):6==s.length&&(s=s.slice(0,3)+s.slice(4,6)),6!=r.length||"-"!=r[0]&&"+"!=r[0]||(r=r.slice(0,3)+r.slice(4)),s+r},_splitZone:function(e,t){let r,s,n=e.length-1,a=e.length-(t?5:6),i=e[a];return"Z"==e[n]?(r=e[n],s=e.slice(0,Math.max(0,n))):e.length>6&&("-"==i||"+"==i)?(r=e.slice(a),s=e.slice(0,Math.max(0,a))):(r="",s=e),[r,s]}},"date-time":{decorate:function(e){return rt.fromDateAndOrTimeString(e,"date-time")},undecorate:function(e){return e.toString()},fromICAL:function(e){return Yt["date-and-or-time"].fromICAL(e)},toICAL:function(e){return Yt["date-and-or-time"].toICAL(e)}},"date-and-or-time":{decorate:function(e){return rt.fromDateAndOrTimeString(e,"date-and-or-time")},undecorate:function(e){return e.toString()},fromICAL:function(e){let t=e.split("T");return(t[0]?Yt.date.fromICAL(t[0]):"")+(t[1]?"T"+Yt.time.fromICAL(t[1]):"")},toICAL:function(e){let t=e.split("T");return Yt.date.toICAL(t[0])+(t[1]?"T"+Yt.time.toICAL(t[1]):"")}},timestamp:Vt["date-time"],"language-tag":{matches:/^[a-zA-Z0-9-]+$/},"phone-number":{fromICAL:function(e){return Array.from(e).filter((function(e){return"\\"===e?void 0:e})).join("")},toICAL:function(e){return Array.from(e).map((function(e){return","===e||";"===e?"\\"+e:e})).join("")}}});let It=Xe(Ct,{adr:{defaultType:"text",structuredValue:";",multiValue:","},anniversary:bt,bday:bt,caladruri:Tt,caluri:Tt,clientpidmap:At,email:gt,fburl:Tt,fn:gt,gender:At,geo:Tt,impp:Tt,key:Tt,kind:gt,lang:{defaultType:"language-tag"},logo:Tt,member:Tt,n:{defaultType:"text",structuredValue:";",multiValue:","},nickname:Dt,note:gt,org:{defaultType:"text",structuredValue:";"},photo:Tt,related:Tt,rev:{defaultType:"timestamp"},role:gt,sound:Tt,source:Tt,tel:{defaultType:"uri",allowedTypes:["uri","text"]},title:gt,tz:{defaultType:"text",allowedTypes:["text","utc-offset","uri"]},xml:gt}),Lt=Xe(Et,{binary:Vt.binary,date:Yt.date,"date-time":Yt["date-time"],"phone-number":Yt["phone-number"],uri:Vt.uri,text:Yt.text,time:Vt.time,vcard:Vt.text,"utc-offset":{toICAL:function(e){return e.slice(0,7)},fromICAL:function(e){return e.slice(0,7)},decorate:function(e){return tt.fromString(e)},undecorate:function(e){return e.toString()}}}),Ut=Xe(Ct,{fn:gt,n:{defaultType:"text",structuredValue:";",multiValue:","},nickname:Dt,photo:{defaultType:"binary",allowedTypes:["binary","uri"]},bday:{defaultType:"date-time",allowedTypes:["date-time","date"],detectType:function(e){return-1===e.indexOf("T")?"date":"date-time"}},adr:{defaultType:"text",structuredValue:";",multiValue:","},label:gt,tel:{defaultType:"phone-number"},email:gt,mailer:gt,tz:{defaultType:"utc-offset",allowedTypes:["utc-offset","text"]},geo:{defaultType:"float",structuredValue:";"},title:gt,role:gt,logo:{defaultType:"binary",allowedTypes:["binary","uri"]},agent:{defaultType:"vcard",allowedTypes:["vcard","text","uri"]},org:At,note:Dt,prodid:gt,rev:{defaultType:"date-time",allowedTypes:["date-time","date"],detectType:function(e){return-1===e.indexOf("T")?"date":"date-time"}},"sort-string":gt,sound:{defaultType:"binary",allowedTypes:["binary","uri"]},class:gt,key:{defaultType:"binary",allowedTypes:["binary","text"]}}),kt={name:"ical",value:Vt,param:{cutype:{values:["INDIVIDUAL","GROUP","RESOURCE","ROOM","UNKNOWN"],allowXName:!0,allowIanaToken:!0},"delegated-from":{valueType:"cal-address",multiValue:",",multiValueSeparateDQuote:!0},"delegated-to":{valueType:"cal-address",multiValue:",",multiValueSeparateDQuote:!0},encoding:{values:["8BIT","BASE64"]},fbtype:{values:["FREE","BUSY","BUSY-UNAVAILABLE","BUSY-TENTATIVE"],allowXName:!0,allowIanaToken:!0},member:{valueType:"cal-address",multiValue:",",multiValueSeparateDQuote:!0},partstat:{values:["NEEDS-ACTION","ACCEPTED","DECLINED","TENTATIVE","DELEGATED","COMPLETED","IN-PROCESS"],allowXName:!0,allowIanaToken:!0},range:{values:["THISANDFUTURE"]},related:{values:["START","END"]},reltype:{values:["PARENT","CHILD","SIBLING"],allowXName:!0,allowIanaToken:!0},role:{values:["REQ-PARTICIPANT","CHAIR","OPT-PARTICIPANT","NON-PARTICIPANT"],allowXName:!0,allowIanaToken:!0},rsvp:{values:["TRUE","FALSE"]},"sent-by":{valueType:"cal-address"},tzid:{matches:/^\//},value:{values:["binary","boolean","cal-address","date","date-time","duration","float","integer","period","recur","text","time","uri","utc-offset"],allowXName:!0,allowIanaToken:!0}},property:Nt,propertyGroups:!1},Pt={name:"vcard4",value:Yt,param:{type:{valueType:"text",multiValue:","},value:{values:["text","uri","date","time","date-time","date-and-or-time","timestamp","boolean","integer","float","utc-offset","language-tag"],allowXName:!0,allowIanaToken:!0}},property:It,propertyGroups:!0},Bt={name:"vcard3",value:Lt,param:{type:{valueType:"text",multiValue:","},value:{values:["text","uri","date","date-time","phone-number","time","boolean","integer","float","utc-offset","vcard","binary"],allowXName:!0,allowIanaToken:!0}},property:Ut,propertyGroups:!0};const Mt={strict:!0,defaultSet:kt,defaultType:"unknown",components:{vcard:Pt,vcard3:Bt,vevent:kt,vtodo:kt,vjournal:kt,valarm:kt,vtimezone:kt,daylight:kt,standard:kt},icalendar:kt,vcard:Pt,vcard3:Bt,getDesignSet:function(e){return e&&e in Mt.components?Mt.components[e]:Mt.defaultSet}},Rt="\r\n",jt="unknown",zt={'"':"^'","\n":"^n","^":"^^"};function Ht(e){"string"==typeof e[0]&&(e=[e]);let t=0,r=e.length,s="";for(;t<r;t++)s+=Ht.component(e[t])+Rt;return s}Ht.component=function(e,t){let r=e[0].toUpperCase(),s="BEGIN:"+r+Rt,n=e[1],a=0,i=n.length,o=e[0];for("vcard"===o&&e[1].length>0&&("version"!==e[1][0][0]||"4.0"!==e[1][0][3])&&(o="vcard3"),t=t||Mt.getDesignSet(o);a<i;a++)s+=Ht.property(n[a],t)+Rt;let l=e[2]||[],c=0,h=l.length;for(;c<h;c++)s+=Ht.component(l[c],t)+Rt;return s+="END:"+r,s},Ht.property=function(e,t,r){let s=e[0].toUpperCase(),n=e[0],a=e[1];t||(t=Mt.defaultSet);let i,o=a.group;i=t.propertyGroups&&o?o.toUpperCase()+"."+s:s;for(let[e,r]of Object.entries(a)){if(t.propertyGroups&&"group"==e)continue;let s=t.param[e],n=s&&s.multiValue;n&&Array.isArray(r)?(r=r.map((function(e){return e=Ht._rfc6868Unescape(e),e=Ht.paramPropertyValue(e,s.multiValueSeparateDQuote)})),r=Ht.multiValue(r,n,"unknown",null,t)):(r=Ht._rfc6868Unescape(r),r=Ht.paramPropertyValue(r)),i+=";"+e.toUpperCase()+"="+r}if(3===e.length)return i+":";let l,c=e[2],h=!1,u=!1,d=!1;return n in t.property?(l=t.property[n],"multiValue"in l&&(h=l.multiValue),"structuredValue"in l&&Array.isArray(e[3])&&(u=l.structuredValue),"defaultType"in l?c===l.defaultType&&(d=!0):c===jt&&(d=!0)):c===jt&&(d=!0),d||(i+=";VALUE="+c.toUpperCase()),i+=":",i+=h&&u?Ht.multiValue(e[3],u,c,h,t,u):h?Ht.multiValue(e.slice(3),h,c,null,t,!1):u?Ht.multiValue(e[3],u,c,null,t,u):Ht.value(e[3],c,t,!1),r?i:Je(i)},Ht.paramPropertyValue=function(e,t){return t||-1!==e.indexOf(",")||-1!==e.indexOf(":")||-1!==e.indexOf(";")?'"'+e+'"':e},Ht.multiValue=function(e,t,r,s,n,a){let i="",o=e.length,l=0;for(;l<o;l++)s&&Array.isArray(e[l])?i+=Ht.multiValue(e[l],s,r,null,n,a):i+=Ht.value(e[l],r,n,a),l!==o-1&&(i+=t);return i},Ht.value=function(e,t,r,s){return t in r.value&&"toICAL"in r.value[t]?r.value[t].toICAL(e,s):e},Ht._rfc6868Unescape=function(e){return e.replace(/[\n^"]/g,(function(e){return zt[e]}))};class Ft{static fromString(e,t){return new Ft(Be.property(e,t))}constructor(e,t){this._parent=t||null,"string"==typeof e?(this.jCal=[e,{},Mt.defaultType],this.jCal[2]=this.getDefaultType()):this.jCal=e,this._updateType()}get type(){return this.jCal[2]}get name(){return this.jCal[0]}get parent(){return this._parent}set parent(e){let t=!this._parent||e&&e._designSet!=this._parent._designSet;this._parent=e,this.type==Mt.defaultType&&t&&(this.jCal[2]=this.getDefaultType(),this._updateType())}get _designSet(){return this.parent?this.parent._designSet:Mt.defaultSet}_updateType(){let e=this._designSet;this.type in e.value&&("decorate"in e.value[this.type]?this.isDecorated=!0:this.isDecorated=!1,this.name in e.property&&(this.isMultiValue="multiValue"in e.property[this.name],this.isStructuredValue="structuredValue"in e.property[this.name]))}_hydrateValue(e){return this._values&&this._values[e]?this._values[e]:this.jCal.length<=3+e?null:this.isDecorated?(this._values||(this._values=[]),this._values[e]=this._decorate(this.jCal[3+e])):this.jCal[3+e]}_decorate(e){return this._designSet.value[this.type].decorate(e,this)}_undecorate(e){return this._designSet.value[this.type].undecorate(e,this)}_setDecoratedValue(e,t){this._values||(this._values=[]),"object"==typeof e&&"icaltype"in e?(this.jCal[3+t]=this._undecorate(e),this._values[t]=e):(this.jCal[3+t]=e,this._values[t]=this._decorate(e))}getParameter(e){return e in this.jCal[1]?this.jCal[1][e]:void 0}getFirstParameter(e){let t=this.getParameter(e);return Array.isArray(t)?t[0]:t}setParameter(e,t){let r=e.toLowerCase();"string"==typeof t&&r in this._designSet.param&&"multiValue"in this._designSet.param[r]&&(t=[t]),this.jCal[1][e]=t}removeParameter(e){delete this.jCal[1][e]}getDefaultType(){let e=this.jCal[0],t=this._designSet;if(e in t.property){let r=t.property[e];if("defaultType"in r)return r.defaultType}return Mt.defaultType}resetType(e){this.removeAllValues(),this.jCal[2]=e,this._updateType()}getFirstValue(){return this._hydrateValue(0)}getValues(){let e=this.jCal.length-3;if(e<1)return[];let t=0,r=[];for(;t<e;t++)r[t]=this._hydrateValue(t);return r}removeAllValues(){this._values&&(this._values.length=0),this.jCal.length=3}setValues(e){if(!this.isMultiValue)throw new Error(this.name+": does not not support mulitValue.\noverride isMultiValue");let t=e.length,r=0;if(this.removeAllValues(),t>0&&"object"==typeof e[0]&&"icaltype"in e[0]&&this.resetType(e[0].icaltype),this.isDecorated)for(;r<t;r++)this._setDecoratedValue(e[r],r);else for(;r<t;r++)this.jCal[3+r]=e[r]}setValue(e){this.removeAllValues(),"object"==typeof e&&"icaltype"in e&&this.resetType(e.icaltype),this.isDecorated?this._setDecoratedValue(e,0):this.jCal[3]=e}toJSON(){return this.jCal}toICALString(){return Ht.property(this.jCal,this._designSet,!0)}}class $t{static fromString(e){return new $t(Be.component(e))}constructor(e,t){"string"==typeof e&&(e=[e,[],[]]),this.jCal=e,this.parent=t||null,this.parent||"vcalendar"!==this.name||(this._timezoneCache=new Map)}_hydratedPropertyCount=0;_hydratedComponentCount=0;_timezoneCache=null;_components=null;_properties=null;get name(){return this.jCal[0]}get _designSet(){let e=this.parent&&this.parent._designSet;if(!e&&"vcard"==this.name){let e=this.jCal[1]?.[0];if(e&&"version"==e[0]&&"3.0"==e[3])return Mt.getDesignSet("vcard3")}return e||Mt.getDesignSet(this.name)}_hydrateComponent(e){if(this._components||(this._components=[],this._hydratedComponentCount=0),this._components[e])return this._components[e];let t=new $t(this.jCal[2][e],this);return this._hydratedComponentCount++,this._components[e]=t}_hydrateProperty(e){if(this._properties||(this._properties=[],this._hydratedPropertyCount=0),this._properties[e])return this._properties[e];let t=new Ft(this.jCal[1][e],this);return this._hydratedPropertyCount++,this._properties[e]=t}getFirstSubcomponent(e){if(e){let t=0,r=this.jCal[2],s=r.length;for(;t<s;t++)if(r[t][0]===e){return this._hydrateComponent(t)}}else if(this.jCal[2].length)return this._hydrateComponent(0);return null}getAllSubcomponents(e){let t=this.jCal[2].length,r=0;if(e){let s=this.jCal[2],n=[];for(;r<t;r++)e===s[r][0]&&n.push(this._hydrateComponent(r));return n}if(!this._components||this._hydratedComponentCount!==t)for(;r<t;r++)this._hydrateComponent(r);return this._components||[]}hasProperty(e){let t=this.jCal[1],r=t.length,s=0;for(;s<r;s++)if(t[s][0]===e)return!0;return!1}getFirstProperty(e){if(e){let t=0,r=this.jCal[1],s=r.length;for(;t<s;t++)if(r[t][0]===e){return this._hydrateProperty(t)}}else if(this.jCal[1].length)return this._hydrateProperty(0);return null}getFirstPropertyValue(e){let t=this.getFirstProperty(e);return t?t.getFirstValue():null}getAllProperties(e){let t=this.jCal[1].length,r=0;if(e){let s=this.jCal[1],n=[];for(;r<t;r++)e===s[r][0]&&n.push(this._hydrateProperty(r));return n}if(!this._properties||this._hydratedPropertyCount!==t)for(;r<t;r++)this._hydrateProperty(r);return this._properties||[]}_removeObjectByIndex(e,t,r){if((t=t||[])[r]){let e=t[r];"parent"in e&&(e.parent=null)}t.splice(r,1),this.jCal[e].splice(r,1)}_removeObject(e,t,r){let s=0,n=this.jCal[e],a=n.length,i=this[t];if("string"==typeof r){for(;s<a;s++)if(n[s][0]===r)return this._removeObjectByIndex(e,i,s),!0}else if(i)for(;s<a;s++)if(i[s]&&i[s]===r)return this._removeObjectByIndex(e,i,s),!0;return!1}_removeAllObjects(e,t,r){let s=this[t],n=this.jCal[e],a=n.length-1;for(;a>=0;a--)r&&n[a][0]!==r||this._removeObjectByIndex(e,s,a)}addSubcomponent(e){this._components||(this._components=[],this._hydratedComponentCount=0),e.parent&&e.parent.removeSubcomponent(e);let t=this.jCal[2].push(e.jCal);return this._components[t-1]=e,this._hydratedComponentCount++,e.parent=this,e}removeSubcomponent(e){let t=this._removeObject(2,"_components",e);return t&&this._hydratedComponentCount--,t}removeAllSubcomponents(e){let t=this._removeAllObjects(2,"_components",e);return this._hydratedComponentCount=0,t}addProperty(e){if(!(e instanceof Ft))throw new TypeError("must be instance of ICAL.Property");this._properties||(this._properties=[],this._hydratedPropertyCount=0),e.parent&&e.parent.removeProperty(e);let t=this.jCal[1].push(e.jCal);return this._properties[t-1]=e,this._hydratedPropertyCount++,e.parent=this,e}addPropertyWithValue(e,t){let r=new Ft(e);return r.setValue(t),this.addProperty(r),r}updatePropertyWithValue(e,t){let r=this.getFirstProperty(e);return r?r.setValue(t):r=this.addPropertyWithValue(e,t),r}removeProperty(e){let t=this._removeObject(1,"_properties",e);return t&&this._hydratedPropertyCount--,t}removeAllProperties(e){let t=this._removeAllObjects(1,"_properties",e);return this._hydratedPropertyCount=0,t}toJSON(){return this.jCal}toString(){return Ht.component(this.jCal,this._designSet)}getTimeZoneByID(e){if(this.parent)return this.parent.getTimeZoneByID(e);if(!this._timezoneCache)return null;if(this._timezoneCache.has(e))return this._timezoneCache.get(e);const t=this.getAllSubcomponents("vtimezone");for(const r of t)if(r.getFirstProperty("tzid").getFirstValue()===e){const t=new je({component:r,tzid:e});return this._timezoneCache.set(e,t),t}return null}}class Wt{constructor(e){this.ruleDates=[],this.exDates=[],this.fromData(e)}complete=!1;ruleIterators=null;ruleDates=null;exDates=null;ruleDateInc=0;exDateInc=0;exDate=null;ruleDate=null;dtstart=null;last=null;fromData(e){let t=We(e.dtstart,Le);if(!t)throw new Error(".dtstart (ICAL.Time) must be given");if(this.dtstart=t,e.component)this._init(e.component);else{if(this.last=We(e.last,Le)||t.clone(),!e.ruleIterators)throw new Error(".ruleIterators or .component must be given");this.ruleIterators=e.ruleIterators.map((function(e){return We(e,st)})),this.ruleDateInc=e.ruleDateInc,this.exDateInc=e.exDateInc,e.ruleDates&&(this.ruleDates=e.ruleDates.map((e=>We(e,Le))),this.ruleDate=this.ruleDates[this.ruleDateInc]),e.exDates&&(this.exDates=e.exDates.map((e=>We(e,Le))),this.exDate=this.exDates[this.exDateInc]),void 0!==e.complete&&(this.complete=e.complete)}}_compare_special(e,t){return!e.isDate&&t.isDate?new Le({year:e.year,month:e.month,day:e.day}).compare(t):e.compare(t)}next(){let e,t,r,s=0;for(;;){if(s++>500)throw new Error("max tries have occurred, rule may be impossible to fulfill.");if(t=this.ruleDate,e=this._nextRecurrenceIter(this.last),!t&&!e){this.complete=!0;break}if((!t||e&&t.compare(e.last)>0)&&(t=e.last.clone(),e.next()),this.ruleDate===t&&this._nextRuleDay(),this.last=t,!this.exDate||(r=this._compare_special(this.last,this.exDate),r>0&&this._nextExDay(),0!==r))return this.last;this._nextExDay()}}toJSON(){function e(e){return e.toJSON()}let t=Object.create(null);return t.ruleIterators=this.ruleIterators.map(e),this.ruleDates&&(t.ruleDates=this.ruleDates.map(e)),this.exDates&&(t.exDates=this.exDates.map(e)),t.ruleDateInc=this.ruleDateInc,t.exDateInc=this.exDateInc,t.last=this.last.toJSON(),t.dtstart=this.dtstart.toJSON(),t.complete=this.complete,t}_extractDates(e,t){let r=[],s=e.getAllProperties(t);for(let e=0,t=s.length;e<t;e++)for(let t of s[e].getValues()){let e=Ze(r,t,((e,t)=>e.compare(t)));r.splice(e,0,t)}return r}_init(e){if(this.ruleIterators=[],this.last=this.dtstart.clone(),!e.hasProperty("rdate")&&!e.hasProperty("rrule")&&!e.hasProperty("recurrence-id"))return this.ruleDate=this.last.clone(),void(this.complete=!0);if(e.hasProperty("rdate")&&(this.ruleDates=this._extractDates(e,"rdate"),this.ruleDates[0]&&this.ruleDates[0].compare(this.dtstart)<0?(this.ruleDateInc=0,this.last=this.ruleDates[0].clone()):this.ruleDateInc=Ze(this.ruleDates,this.last,((e,t)=>e.compare(t))),this.ruleDate=this.ruleDates[this.ruleDateInc]),e.hasProperty("rrule")){let t,r,s=e.getAllProperties("rrule"),n=0,a=s.length;for(;n<a;n++)t=s[n].getFirstValue(),r=t.iterator(this.dtstart),this.ruleIterators.push(r),r.next()}e.hasProperty("exdate")&&(this.exDates=this._extractDates(e,"exdate"),this.exDateInc=Ze(this.exDates,this.last,this._compare_special),this.exDate=this.exDates[this.exDateInc])}_nextExDay(){this.exDate=this.exDates[++this.exDateInc]}_nextRuleDay(){this.ruleDate=this.ruleDates[++this.ruleDateInc]}_nextRecurrenceIter(){let e=this.ruleIterators;if(0===e.length)return null;let t,r,s,n=e.length,a=0;for(;a<n;a++)t=e[a],r=t.last,t.completed?(n--,0!==a&&a--,e.splice(a,1)):(!s||s.last.compare(r)>0)&&(s=t);return s}}class qt{constructor(e,t){e instanceof $t||(t=e,e=null),this.component=e||new $t("vevent"),this._rangeExceptionCache=Object.create(null),this.exceptions=Object.create(null),this.rangeExceptions=[],t&&t.strictExceptions&&(this.strictExceptions=t.strictExceptions),t&&t.exceptions?t.exceptions.forEach(this.relateException,this):this.component.parent&&!this.isRecurrenceException()&&this.component.parent.getAllSubcomponents("vevent").forEach((function(e){e.hasProperty("recurrence-id")&&this.relateException(e)}),this)}static THISANDFUTURE="THISANDFUTURE";exceptions=null;strictExceptions=!1;relateException(e){if(this.isRecurrenceException())throw new Error("cannot relate exception to exceptions");if(e instanceof $t&&(e=new qt(e)),this.strictExceptions&&e.uid!==this.uid)throw new Error("attempted to relate unrelated exception");let t=e.recurrenceId.toString();if(this.exceptions[t]=e,e.modifiesFuture()){let r=[e.recurrenceId.toUnixTime(),t],s=Ze(this.rangeExceptions,r,Zt);this.rangeExceptions.splice(s,0,r)}}modifiesFuture(){if(!this.component.hasProperty("recurrence-id"))return!1;return this.component.getFirstProperty("recurrence-id").getParameter("range")===qt.THISANDFUTURE}findRangeException(e){if(!this.rangeExceptions.length)return null;let t=e.toUnixTime(),r=Ze(this.rangeExceptions,[t],Zt);if(r-=1,r<0)return null;let s=this.rangeExceptions[r];return t<s[0]?null:s[1]}getOccurrenceDetails(e){let t,r=e.toString(),s=e.convertToZone(je.utcTimezone).toString(),n={recurrenceId:e};if(r in this.exceptions)t=n.item=this.exceptions[r],n.startDate=t.startDate,n.endDate=t.endDate,n.item=t;else if(s in this.exceptions)t=this.exceptions[s],n.startDate=t.startDate,n.endDate=t.endDate,n.item=t;else{let t,r=this.findRangeException(e);if(r){let s=this.exceptions[r];n.item=s;let a=this._rangeExceptionCache[r];if(!a){let e=s.recurrenceId.clone(),t=s.startDate.clone();e.zone=t.zone,a=t.subtractDate(e),this._rangeExceptionCache[r]=a}let i=e.clone();i.zone=s.startDate.zone,i.addDuration(a),t=i.clone(),t.addDuration(s.duration),n.startDate=i,n.endDate=t}else t=e.clone(),t.addDuration(this.duration),n.endDate=t,n.startDate=e,n.item=this}return n}iterator(e){return new Wt({component:this.component,dtstart:e||this.startDate})}isRecurring(){let e=this.component;return e.hasProperty("rrule")||e.hasProperty("rdate")}isRecurrenceException(){return this.component.hasProperty("recurrence-id")}getRecurrenceTypes(){let e=this.component.getAllProperties("rrule"),t=0,r=e.length,s=Object.create(null);for(;t<r;t++){s[e[t].getFirstValue().freq]=!0}return s}get uid(){return this._firstProp("uid")}set uid(e){this._setProp("uid",e)}get startDate(){return this._firstProp("dtstart")}set startDate(e){this._setTime("dtstart",e)}get endDate(){let e=this._firstProp("dtend");if(!e){let t=this._firstProp("duration");e=this.startDate.clone(),t?e.addDuration(t):e.isDate&&(e.day+=1)}return e}set endDate(e){this.component.hasProperty("duration")&&this.component.removeProperty("duration"),this._setTime("dtend",e)}get duration(){let e=this._firstProp("duration");return e||this.endDate.subtractDateTz(this.startDate)}set duration(e){this.component.hasProperty("dtend")&&this.component.removeProperty("dtend"),this._setProp("duration",e)}get location(){return this._firstProp("location")}set location(e){this._setProp("location",e)}get attendees(){return this.component.getAllProperties("attendee")}get summary(){return this._firstProp("summary")}set summary(e){this._setProp("summary",e)}get description(){return this._firstProp("description")}set description(e){this._setProp("description",e)}get color(){return this._firstProp("color")}set color(e){this._setProp("color",e)}get organizer(){return this._firstProp("organizer")}set organizer(e){this._setProp("organizer",e)}get sequence(){return this._firstProp("sequence")}set sequence(e){this._setProp("sequence",e)}get recurrenceId(){return this._firstProp("recurrence-id")}set recurrenceId(e){this._setTime("recurrence-id",e)}_setTime(e,t){let r=this.component.getFirstProperty(e);r||(r=new Ft(e),this.component.addProperty(r)),t.zone===je.localTimezone||t.zone===je.utcTimezone?r.removeParameter("tzid"):r.setParameter("tzid",t.zone.tzid),r.setValue(t)}_setProp(e,t){this.component.updatePropertyWithValue(e,t)}_firstProp(e){return this.component.getFirstPropertyValue(e)}toString(){return this.component.toString()}}function Zt(e,t){return e[0]>t[0]?1:t[0]>e[0]?-1:0}var Kt={foldLength:75,debug:!1,newLineChar:"\r\n",Binary:Ce,Component:$t,ComponentParser:class{constructor(e){void 0===e&&(e={});for(let[t,r]of Object.entries(e))this[t]=r}parseEvent=!0;parseTimezone=!0;oncomplete=function(){};onerror=function(e){};ontimezone=function(e){};onevent=function(e){};process(e){"string"==typeof e&&(e=Be(e)),e instanceof $t||(e=new $t(e));let t,r=e.getAllSubcomponents(),s=0,n=r.length;for(;s<n;s++)switch(t=r[s],t.name){case"vtimezone":if(this.parseTimezone){let e=t.getFirstPropertyValue("tzid");e&&this.ontimezone(new je({tzid:e,component:t}))}break;case"vevent":this.parseEvent&&this.onevent(new qt(t));break;default:continue}this.oncomplete()}},Duration:Ne,Event:qt,Period:Ie,Property:Ft,Recur:ht,RecurExpansion:Wt,RecurIterator:st,Time:Le,Timezone:je,TimezoneService:He,UtcOffset:tt,VCardTime:rt,parse:Be,stringify:Ht,design:Mt,helpers:et};function Jt(e){try{const t=function(e){return e.replace(/\r\n /g,"").replace(/\n /g,"")}(e),r=Kt.parse(t);return new Kt.Component(r)}catch(e){throw new Error(`Failed to parse iCal component: ${e instanceof Error?e.message:String(e)}`)}}function Gt(e){try{const t=e.toString().split(/\r\n|\n/);return t.map((e=>function(e,t=75){if(e.length<=t)return e;const r=[];let s=e;for(r.push(s.substring(0,t)),s=s.substring(t);s.length>0;){const e=s.substring(0,t-1);r.push(` ${e}`),s=s.substring(t-1)}return r.join("\r\n")}(e))).join("\r\n")}catch(e){throw new Error(`Failed to serialize iCal component: ${e instanceof Error?e.message:String(e)}`)}}function Qt(e){const t=e.getFirstPropertyValue("sequence"),r="number"==typeof t?t+1:0;e.getFirstProperty("sequence")?e.updatePropertyWithValue("sequence",r):e.addPropertyWithValue("sequence",r)}function Xt(e){const t=Kt.Time.now();e.getFirstProperty("dtstamp")?e.updatePropertyWithValue("dtstamp",t):e.addPropertyWithValue("dtstamp",t)}function er(e,t){t.getAllProperties().forEach((t=>{const r=t.name;if(r.toLowerCase().startsWith("x-")){e.getAllProperties().find((e=>e.name.toLowerCase()===r.toLowerCase()))||e.addProperty(t)}}))}function tr(e){const t=e.getFirstPropertyValue("sequence");return"number"==typeof t?t:0}function rr(e){const t=e.getFirstPropertyValue("dtstamp");return t?"object"==typeof t&&"toICALString"in t&&"function"==typeof t.toICALString?t.toICALString():t.toString():null}function sr(e){if(!e.getFirstPropertyValue("uid"))throw new Error("UID property is required and must not be removed")}const nr={autoIncrementSequence:!0,autoUpdateDtstamp:!0,preserveUnknownFields:!0,preserveVendorExtensions:!0};const ar={autoIncrementSequence:!1,autoUpdateDtstamp:!1,preserveUnknownFields:!0,preserveVendorExtensions:!0},ir=new Set(["FN","N","EMAIL","TEL","ORG","NOTE","TITLE","URL"]);const or={autoIncrementSequence:!0,autoUpdateDtstamp:!0,preserveUnknownFields:!0,preserveVendorExtensions:!0};function lr(e,t,r){const s={...or,...r};if(!e.data)throw new Error("calendarObject.data is required");if("string"!=typeof e.data)throw new Error("calendarObject.data must be a string (iCal format)");const n=Jt(e.data),a=n.getFirstSubcomponent("vtodo");if(!a)throw new Error("VTODO component not found in calendar object");sr(a);const i=new Kt.Component(a.toJSON());let o=!1;const l=[];if(void 0!==t.SUMMARY){if(a.getFirstPropertyValue("summary")!==t.SUMMARY)if(null===t.SUMMARY||""===t.SUMMARY){const e=a.getFirstProperty("summary");e&&(a.removeProperty(e),o=!0)}else a.getFirstProperty("summary")?a.updatePropertyWithValue("summary",t.SUMMARY):a.addPropertyWithValue("summary",t.SUMMARY),o=!0}if(void 0!==t.DESCRIPTION){if(a.getFirstPropertyValue("description")!==t.DESCRIPTION)if(null===t.DESCRIPTION||""===t.DESCRIPTION){const e=a.getFirstProperty("description");e&&(a.removeProperty(e),o=!0)}else a.getFirstProperty("description")?a.updatePropertyWithValue("description",t.DESCRIPTION):a.addPropertyWithValue("description",t.DESCRIPTION),o=!0}let c,h;if(s.autoIncrementSequence&&o){const e=tr(a);Qt(a),c=tr(a),e===c&&l.push(`SEQUENCE already at value ${c}, not incremented`)}s.autoUpdateDtstamp&&o&&(Xt(a),h=rr(a)||void 0);let u=0;if(s.preserveVendorExtensions){u=i.getAllProperties().filter((e=>e.name.toLowerCase().startsWith("x-"))).length,er(a,i),u>0&&l.push(`Preserved ${u} vendor extension(s)`)}sr(a);return{data:Gt(n),modified:o,warnings:l.length>0?l:void 0,metadata:{sequence:c,dtstamp:h,vendorExtensionsCount:u>0?u:void 0}}}var cr={DAVNamespace:exports.DAVNamespace,DAVNamespaceShort:exports.DAVNamespaceShort,DAVAttributeMap:a,...Se,...x,...L,...le,...H,...re,...ge,...xe,...g};exports.DAVAttributeMap=a,exports.DAVClient=be,exports.addressBookMultiGet=P,exports.addressBookQuery=k,exports.batchUpdateTodoFields=function(e,t,r){return e.map((e=>lr(e,t,r)))},exports.calendarMultiGet=q,exports.calendarQuery=W,exports.cleanupFalsy=d,exports.collectionQuery=C,exports.createAccount=oe,exports.createCalendarObject=G,exports.createDAVClient=we,exports.createObject=O,exports.createTodo=fe,exports.createVCard=R,exports.davRequest=A,exports.default=cr,exports.deleteCalendarObject=X,exports.deleteObject=T,exports.deleteTodo=ye,exports.deleteVCard=z,exports.extractEventFields=function(e){if(!e.data)throw new Error("calendarObject.data is required");try{const t=Jt(e.data).getFirstSubcomponent("vevent");if(!t)throw new Error("VEVENT component not found in VCALENDAR");const r={},s=t.getFirstPropertyValue("summary");null!=s&&"string"==typeof s&&(r.SUMMARY=s);const n=t.getFirstPropertyValue("description");return null!=n&&"string"==typeof n&&(r.DESCRIPTION=n),r}catch(e){throw new Error(`Failed to extract event fields: ${e instanceof Error?e.message:String(e)}`)}},exports.extractTodoFields=function(e){if(!e.data||"string"!=typeof e.data)throw new Error("calendarObject.data must be a string (iCal format)");const t=Jt(e.data).getFirstSubcomponent("vtodo");if(!t)throw new Error("VTODO component not found in calendar object");const r={},s=t.getFirstPropertyValue("summary");null!==s&&"string"==typeof s&&(r.SUMMARY=s);const n=t.getFirstPropertyValue("description");return null!==n&&"string"==typeof n&&(r.DESCRIPTION=n),r},exports.extractVCardFields=function(e){if(!e.data||"string"!=typeof e.data)throw new Error("Invalid vCard data");try{const t=Jt(e.data);let r=null;if("vcard"===t.name?r=t:"vcalendar"===t.name&&(r=t.getFirstSubcomponent("vcard")),!r)throw new Error("No VCARD component found");const s={};for(const e of ir){const t=r.getFirstPropertyValue(e.toLowerCase());null!=t&&(s[e]=String(t))}return s}catch(e){throw new Error(`Failed to extract vCard fields: ${e instanceof Error?e.message:String(e)}`)}},exports.fetchAddressBooks=B,exports.fetchCalendarObjects=J,exports.fetchCalendarUserAddresses=$,exports.fetchCalendars=K,exports.fetchOauthTokens=Oe,exports.fetchTodos=pe,exports.fetchVCards=M,exports.freeBusyQuery=te,exports.getBasicAuthHeaders=_e,exports.getDAVAttribute=u,exports.getOauthHeaders=Te,exports.hasValidVEvent=function(e){try{if(!e.data)return!1;const t=Jt(e.data).getFirstSubcomponent("vevent");if(!t)return!1;return!!t.getFirstPropertyValue("uid")}catch(e){return!1}},exports.isCollectionDirty=N,exports.isTodoObject=function(e){try{if(!e.data||"string"!=typeof e.data)return!1;const t=Jt(e.data);return null!==t.getFirstSubcomponent("vtodo")}catch(e){return!1}},exports.makeCalendar=Z,exports.propfind=_,exports.refreshAccessToken=ve,exports.smartCollectionSync=I,exports.supportedReportSet=V,exports.syncCalendars=ee,exports.syncCollection=Y,exports.todoMultiGet=de,exports.todoQuery=ue,exports.updateCalendarObject=Q,exports.updateEventFields=function(e,t,r){const s={...nr,...r};if(!e.data)throw new Error("calendarObject.data is required");if(!t||0===Object.keys(t).length)throw new Error("At least one field must be specified for update");const n=[];let a=!1;try{const r=Jt(e.data),i=r.getFirstSubcomponent("vevent");if(!i)throw new Error("VEVENT component not found in VCALENDAR");sr(i);const o=i.getFirstPropertyValue("uid"),l=new Kt.Component(i.toJSON());for(const[e,r]of Object.entries(t)){const t=e.toLowerCase();if(i.getFirstPropertyValue(t)!==r)if(a=!0,null==r||""===r){const r=i.getFirstProperty(t);r&&(i.removeProperty(r),n.push(`${e} removed (empty value provided)`))}else i.getFirstProperty(t)?i.updatePropertyWithValue(t,r):i.addPropertyWithValue(t,r)}a&&(s.autoIncrementSequence&&Qt(i),s.autoUpdateDtstamp&&Xt(i)),s.preserveVendorExtensions&&er(i,l);if(i.getFirstPropertyValue("uid")!==o)throw new Error("UID must not be modified");r.getAllSubcomponents("vtimezone").length;const c=Gt(r),h=tr(i),u=rr(i),d=i.getAllProperties().filter((e=>e.name.toLowerCase().startsWith("x-"))).length;return d>0&&n.push(`Preserved ${d} vendor extension(s)`),{data:c,modified:a,warnings:n.length>0?n:void 0,metadata:{sequence:h,dtstamp:u||void 0,vendorExtensionsCount:d>0?d:void 0}}}catch(e){throw new Error(`Failed to update event fields: ${e instanceof Error?e.message:String(e)}`)}},exports.updateObject=v,exports.updateTodo=me,exports.updateTodoFields=lr,exports.updateVCard=j,exports.updateVCardFields=function(e,t,r){const s={...ar,...r};if(!e.data)throw new Error("vCard data is required");if("string"!=typeof e.data)throw new Error("vCard data must be a string");let n;try{n=Jt(e.data)}catch(e){throw new Error(`Failed to parse vCard: ${e instanceof Error?e.message:String(e)}`)}let a=null;if("vcard"===n.name?a=n:"vcalendar"===n.name&&(a=n.getFirstSubcomponent("vcard")),!a)throw new Error("No VCARD component found in data");const i=a.toJSON();let o=!1;const l=[];if(!a.getFirstPropertyValue("uid"))throw new Error("vCard must have a UID property");const c=a.getFirstPropertyValue("fn");if(""===t.FN&&c)throw new Error("FN (Formatted Name) is a required field and cannot be removed");for(const[e,r]of Object.entries(t)){if(!ir.has(e)){l.push(`Unknown field '${e}' - skipping`);continue}const t=e.toLowerCase(),s=a.getFirstPropertyValue(t);if(""===r){if(null!==s){const e=a.getFirstProperty(t);e&&(a.removeProperty(e),o=!0)}continue}if(s===r)continue;a.getFirstProperty(t)?a.updatePropertyWithValue(t,r):a.addPropertyWithValue(t,r),o=!0}if(o){const e=Kt.Time.now();a.getFirstProperty("rev")?a.updatePropertyWithValue("rev",e):a.addPropertyWithValue("rev",e)}let h,u=0;if(s.preserveVendorExtensions){er(a,new Kt.Component(i)),u=a.getAllProperties().filter((e=>e.name.toLowerCase().startsWith("x-"))).length,u>0&&l.push(`Preserved ${u} vendor extension${u>1?"s":""}`)}try{h=Gt(n)}catch(e){throw new Error(`Failed to serialize vCard: ${e instanceof Error?e.message:String(e)}`)}const d={data:h,modified:o};if(l.length>0&&(d.warnings=l),o){d.metadata={};const e=a.getFirstPropertyValue("rev");e&&("object"==typeof e&&"toICALString"in e&&"function"==typeof e.toICALString?d.metadata.dtstamp=e.toICALString():d.metadata.dtstamp=e.toString()),s.preserveVendorExtensions&&u>0&&(d.metadata.vendorExtensionsCount=u)}return d},exports.urlContains=h,exports.urlEquals=c,exports.validateVCardFields=function(e){const t=[];if("FN"in e&&""===e.FN&&t.push("FN (Formatted Name) is required and cannot be empty"),e.N&&e.N.length>0&&(e.N.includes(";")||t.push("N (Structured Name) should be in format: Family;Given;Additional;Prefix;Suffix")),e.URL&&e.URL.length>0)try{new URL(e.URL)}catch(e){t.push("URL is not a valid URL format")}return t};
